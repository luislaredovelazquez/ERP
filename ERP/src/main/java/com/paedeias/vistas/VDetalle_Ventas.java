/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package com.paedeias.vistas;

import com.paedeias.controladores.CConfiguracion;
import com.paedeias.controladores.CGlobalConfig;
import com.paedeias.controladores.CPrincipal;
import com.paedeias.controladores.Numero_a_Letra;
import com.paedeias.controladores.impresiones.*;
import com.paedeias.helpers.*;
import com.paedeias.identidades.*;
import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.FlowLayout;
import java.awt.GridLayout;
import java.awt.Window;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.print.*;
import java.io.IOException;
import java.text.DecimalFormat;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.List;
import java.util.Vector;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.*;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author ALL
 */
public class VDetalle_Ventas extends javax.swing.JPanel {

    /**
     * Creates new form VDetalle_Ventas
     */
    public VDetalle_Ventas(Ventas venta) {
        initComponents();
        inicializar(venta);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jLabel17 = new javax.swing.JLabel();
        jLabel18 = new javax.swing.JLabel();
        jLabel19 = new javax.swing.JLabel();
        jLabel20 = new javax.swing.JLabel();
        jLabel21 = new javax.swing.JLabel();
        jLabel22 = new javax.swing.JLabel();
        jPanel2 = new javax.swing.JPanel();
        jLabel29 = new javax.swing.JLabel();
        jLabel30 = new javax.swing.JLabel();
        jLabel31 = new javax.swing.JLabel();
        jLabel32 = new javax.swing.JLabel();
        jPanel4 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        jLabel7 = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();
        jLabel9 = new javax.swing.JLabel();
        jLabel10 = new javax.swing.JLabel();
        jLabel11 = new javax.swing.JLabel();
        jLabel12 = new javax.swing.JLabel();
        jLabel13 = new javax.swing.JLabel();
        jLabel14 = new javax.swing.JLabel();
        jLabel15 = new javax.swing.JLabel();
        jLabel16 = new javax.swing.JLabel();
        jLabel33 = new javax.swing.JLabel();
        jLabel34 = new javax.swing.JLabel();
        jCheckBox1 = new javax.swing.JCheckBox();
        jButton4 = new javax.swing.JButton();
        jButton3 = new javax.swing.JButton();
        jPanel3 = new javax.swing.JPanel();
        jLabel23 = new javax.swing.JLabel();
        jLabel24 = new javax.swing.JLabel();
        jLabel25 = new javax.swing.JLabel();
        jLabel26 = new javax.swing.JLabel();
        jLabel27 = new javax.swing.JLabel();
        jLabel28 = new javax.swing.JLabel();
        jPanel5 = new javax.swing.JPanel();
        jButton1 = new javax.swing.JButton();
        jTextField1 = new javax.swing.JTextField();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTable1 = new javax.swing.JTable();
        jLabel35 = new javax.swing.JLabel();
        jTextField2 = new javax.swing.JTextField();
        jButton2 = new javax.swing.JButton();
        jButton5 = new javax.swing.JButton();
        jButton6 = new javax.swing.JButton();
        jButton7 = new javax.swing.JButton();
        jButton8 = new javax.swing.JButton();
        jButton9 = new javax.swing.JButton();
        jButton10 = new javax.swing.JButton();

        setBackground(new java.awt.Color(255, 255, 255));

        jPanel1.setBackground(new java.awt.Color(255, 255, 255));
        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder("Usuario"));

        jLabel17.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel17.setForeground(new java.awt.Color(102, 102, 102));
        jLabel17.setText("Login:");

        jLabel18.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel18.setForeground(new java.awt.Color(102, 102, 102));
        jLabel18.setText("Usuario:");

        jLabel19.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel19.setForeground(new java.awt.Color(102, 102, 102));
        jLabel19.setText("Puesto:");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel17)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel20, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel19)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel22, javax.swing.GroupLayout.DEFAULT_SIZE, 157, Short.MAX_VALUE)
                        .addGap(3, 3, 3))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel18)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel21, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                .addContainerGap())
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel17)
                    .addComponent(jLabel20, javax.swing.GroupLayout.PREFERRED_SIZE, 14, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel18)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jLabel19))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel21, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel22, javax.swing.GroupLayout.PREFERRED_SIZE, 14, javax.swing.GroupLayout.PREFERRED_SIZE))))
        );

        jPanel2.setBackground(new java.awt.Color(255, 255, 255));
        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder("Cliente"));

        jLabel29.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel29.setForeground(new java.awt.Color(102, 102, 102));
        jLabel29.setText("Nombre:");

        jLabel31.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel31.setForeground(new java.awt.Color(102, 102, 102));
        jLabel31.setText("RFC:");

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addComponent(jLabel29)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel30, javax.swing.GroupLayout.DEFAULT_SIZE, 269, Short.MAX_VALUE))
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addComponent(jLabel31)
                        .addGap(18, 18, 18)
                        .addComponent(jLabel32, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addGap(5, 5, 5))))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel29)
                    .addComponent(jLabel30, javax.swing.GroupLayout.PREFERRED_SIZE, 14, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jLabel31, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jLabel32, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap(32, Short.MAX_VALUE))
        );

        jPanel4.setBackground(new java.awt.Color(255, 255, 255));
        jPanel4.setBorder(javax.swing.BorderFactory.createTitledBorder("Venta"));

        jLabel1.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel1.setForeground(new java.awt.Color(102, 102, 102));
        jLabel1.setText("Número de Venta:");

        jLabel2.setText("000000");

        jLabel3.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel3.setForeground(new java.awt.Color(102, 102, 102));
        jLabel3.setText("Artículos:");

        jLabel4.setText("000000");

        jLabel5.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel5.setForeground(new java.awt.Color(102, 102, 102));
        jLabel5.setText("Partidas:");

        jLabel6.setText("000000");

        jLabel7.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel7.setForeground(new java.awt.Color(102, 102, 102));
        jLabel7.setText("Subtotal:");

        jLabel8.setText("000000");

        jLabel9.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel9.setForeground(new java.awt.Color(102, 102, 102));
        jLabel9.setText("Total:");

        jLabel10.setText("000000");

        jLabel11.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel11.setForeground(new java.awt.Color(102, 102, 102));
        jLabel11.setText("Tipo de Venta:");

        jLabel12.setText("Efectivo");

        jLabel13.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel13.setForeground(new java.awt.Color(102, 102, 102));
        jLabel13.setText("Fecha de Venta:");

        jLabel14.setText("00/00/00 T 00:00:00");

        jLabel15.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel15.setForeground(new java.awt.Color(102, 102, 102));
        jLabel15.setText("Observaciones:");

        jLabel33.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel33.setForeground(new java.awt.Color(102, 102, 102));
        jLabel33.setText("Estado:");

        jLabel34.setText("Vivo");

        jCheckBox1.setBackground(new java.awt.Color(255, 255, 255));
        jCheckBox1.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jCheckBox1.setForeground(new java.awt.Color(102, 102, 102));
        jCheckBox1.setText("Facturada");

        jButton4.setBackground(new java.awt.Color(11, 70, 119));
        jButton4.setForeground(new java.awt.Color(255, 255, 255));
        jButton4.setText("Reimprimir");
        jButton4.setContentAreaFilled(false);
        jButton4.setOpaque(true);
        jButton4.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton4ActionPerformed(evt);
            }
        });

        jButton3.setBackground(new java.awt.Color(11, 70, 119));
        jButton3.setForeground(new java.awt.Color(255, 255, 255));
        jButton3.setText("Enviar a Sucursal");
        jButton3.setContentAreaFilled(false);
        jButton3.setOpaque(true);
        jButton3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton3ActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel4Layout = new javax.swing.GroupLayout(jPanel4);
        jPanel4.setLayout(jPanel4Layout);
        jPanel4Layout.setHorizontalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel4Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel4Layout.createSequentialGroup()
                        .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(jPanel4Layout.createSequentialGroup()
                                .addComponent(jLabel15)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jLabel16, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                            .addGroup(jPanel4Layout.createSequentialGroup()
                                .addComponent(jLabel11)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jLabel12)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jLabel13)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jLabel14)
                                .addGap(13, 13, 13)
                                .addComponent(jCheckBox1)
                                .addGap(0, 0, Short.MAX_VALUE)))
                        .addGap(2, 2, 2))
                    .addGroup(jPanel4Layout.createSequentialGroup()
                        .addComponent(jLabel1)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel2)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel3)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel4)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel5)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel6)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel7)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel8)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel9)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel10)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel33)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel34)
                        .addGap(74, 74, 74)))
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                    .addComponent(jButton3, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 141, Short.MAX_VALUE)
                    .addComponent(jButton4, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap())
        );
        jPanel4Layout.setVerticalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel4Layout.createSequentialGroup()
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(jLabel2)
                    .addComponent(jLabel3)
                    .addComponent(jLabel4)
                    .addComponent(jLabel5)
                    .addComponent(jLabel6)
                    .addComponent(jLabel7)
                    .addComponent(jLabel8)
                    .addComponent(jLabel9)
                    .addComponent(jLabel10)
                    .addComponent(jLabel33)
                    .addComponent(jLabel34)
                    .addComponent(jButton3))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel13)
                        .addComponent(jLabel14)
                        .addComponent(jCheckBox1)
                        .addComponent(jButton4))
                    .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel11)
                        .addComponent(jLabel12)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel15, javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(jLabel16, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 14, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(20, 20, 20))
        );

        jPanel3.setBackground(new java.awt.Color(255, 255, 255));
        jPanel3.setBorder(javax.swing.BorderFactory.createTitledBorder("Administrador"));

        jLabel23.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel23.setForeground(new java.awt.Color(102, 102, 102));
        jLabel23.setText("Login:");

        jLabel24.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel24.setForeground(new java.awt.Color(102, 102, 102));
        jLabel24.setText("Usuario:");

        jLabel25.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel25.setForeground(new java.awt.Color(102, 102, 102));
        jLabel25.setText("Puesto:");

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel3Layout.createSequentialGroup()
                        .addComponent(jLabel23)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel26, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                    .addGroup(jPanel3Layout.createSequentialGroup()
                        .addComponent(jLabel24)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel27, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                    .addGroup(jPanel3Layout.createSequentialGroup()
                        .addComponent(jLabel25)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel28, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                .addContainerGap(18, javax.swing.GroupLayout.PREFERRED_SIZE))
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel23)
                    .addComponent(jLabel26, javax.swing.GroupLayout.PREFERRED_SIZE, 14, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel3Layout.createSequentialGroup()
                        .addComponent(jLabel24)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jLabel25))
                    .addGroup(jPanel3Layout.createSequentialGroup()
                        .addComponent(jLabel27, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel28, javax.swing.GroupLayout.PREFERRED_SIZE, 14, javax.swing.GroupLayout.PREFERRED_SIZE))))
        );

        jPanel5.setBackground(new java.awt.Color(255, 255, 255));
        jPanel5.setBorder(javax.swing.BorderFactory.createTitledBorder("Partidas"));

        jButton1.setBackground(new java.awt.Color(11, 70, 119));
        jButton1.setForeground(new java.awt.Color(255, 255, 255));
        jButton1.setText("Devolver Piezas");
        jButton1.setContentAreaFilled(false);
        jButton1.setEnabled(false);
        jButton1.setOpaque(true);
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        jTextField1.setText("1");
        jTextField1.setEnabled(false);

        jTable1.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        jScrollPane1.setViewportView(jTable1);

        jLabel35.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jLabel35.setForeground(new java.awt.Color(102, 102, 102));
        jLabel35.setText("Observación (En caso de devolución) :");

        jTextField2.setEditable(false);

        javax.swing.GroupLayout jPanel5Layout = new javax.swing.GroupLayout(jPanel5);
        jPanel5.setLayout(jPanel5Layout);
        jPanel5Layout.setHorizontalGroup(
            jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel5Layout.createSequentialGroup()
                .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.Alignment.TRAILING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel5Layout.createSequentialGroup()
                        .addGap(0, 0, Short.MAX_VALUE)
                        .addComponent(jTextField1, javax.swing.GroupLayout.PREFERRED_SIZE, 69, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 175, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel5Layout.createSequentialGroup()
                        .addComponent(jLabel35)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jTextField2)))
                .addContainerGap())
        );
        jPanel5Layout.setVerticalGroup(
            jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel5Layout.createSequentialGroup()
                .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jTextField1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jButton1))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 162, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel35)
                    .addComponent(jTextField2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jButton2.setBackground(new java.awt.Color(11, 70, 119));
        jButton2.setForeground(new java.awt.Color(255, 255, 255));
        jButton2.setText("Habilitar");
        jButton2.setContentAreaFilled(false);
        jButton2.setOpaque(true);
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });

        jButton5.setBackground(new java.awt.Color(11, 70, 119));
        jButton5.setForeground(new java.awt.Color(255, 255, 255));
        jButton5.setText("Devolver Parcial");
        jButton5.setContentAreaFilled(false);
        jButton5.setEnabled(false);
        jButton5.setOpaque(true);
        jButton5.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton5ActionPerformed(evt);
            }
        });

        jButton6.setBackground(new java.awt.Color(11, 70, 119));
        jButton6.setForeground(new java.awt.Color(255, 255, 255));
        jButton6.setText("Cancelar Parcial");
        jButton6.setContentAreaFilled(false);
        jButton6.setEnabled(false);
        jButton6.setOpaque(true);
        jButton6.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton6ActionPerformed(evt);
            }
        });

        jButton7.setBackground(new java.awt.Color(11, 70, 119));
        jButton7.setForeground(new java.awt.Color(255, 255, 255));
        jButton7.setText("Cancelar Cambios");
        jButton7.setContentAreaFilled(false);
        jButton7.setEnabled(false);
        jButton7.setOpaque(true);
        jButton7.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton7ActionPerformed(evt);
            }
        });

        jButton8.setBackground(new java.awt.Color(11, 70, 119));
        jButton8.setForeground(new java.awt.Color(255, 255, 255));
        jButton8.setText("Devolver Venta Completa");
        jButton8.setContentAreaFilled(false);
        jButton8.setEnabled(false);
        jButton8.setOpaque(true);
        jButton8.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton8ActionPerformed(evt);
            }
        });

        jButton9.setBackground(new java.awt.Color(11, 70, 119));
        jButton9.setForeground(new java.awt.Color(255, 255, 255));
        jButton9.setText("Cancelar Venta Completa");
        jButton9.setContentAreaFilled(false);
        jButton9.setEnabled(false);
        jButton9.setOpaque(true);
        jButton9.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton9ActionPerformed(evt);
            }
        });

        jButton10.setBackground(new java.awt.Color(11, 70, 119));
        jButton10.setForeground(new java.awt.Color(255, 255, 255));
        jButton10.setText("CFDI");
        jButton10.setContentAreaFilled(false);
        jButton10.setEnabled(false);
        jButton10.setOpaque(true);
        jButton10.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton10ActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel5, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel4, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addComponent(jButton2)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jButton10, javax.swing.GroupLayout.PREFERRED_SIZE, 81, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButton8)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jButton9)
                        .addGap(4, 4, 4)
                        .addComponent(jButton5)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButton6)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButton7)
                        .addGap(7, 7, 7)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(13, 13, 13)
                .addComponent(jPanel4, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel5, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jButton2)
                    .addComponent(jButton5)
                    .addComponent(jButton6)
                    .addComponent(jButton7)
                    .addComponent(jButton8)
                    .addComponent(jButton9)
                    .addComponent(jButton10))
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        // TODO add your handling code here:
        if(jLabel34.getText().equals("Devuelta"))
        {
            JOptionPane.showMessageDialog(null, "Esta Venta ya ha sido devuelta");
            return;
        }
        
         if(jTable1.getSelectedRow() == -1)
        {
            JOptionPane.showMessageDialog(null, "Por favor seleccione primero una fila");
            return;
        }
        
        if (jTable1.getSelectedRow()!=-1&&listaPartidas.get(jTable1.getSelectedRow()).getCantidad() == Integer.parseInt(jTextField1.getText()))
        {
            Partidasdevoluciones devolucion = new Partidasdevoluciones();
            devolucion.setBeneficio(listaPartidas.get(jTable1.getSelectedRow()).getBeneficio());
            devolucion.setCantidad(listaPartidas.get(jTable1.getSelectedRow()).getCantidad());
            devolucion.setCodigoArticulo(listaPartidas.get(jTable1.getSelectedRow()).getCodigoArticulo());
            devolucion.setConBeneficio(listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio());
            devolucion.setDescripcionArticulo(listaPartidas.get(jTable1.getSelectedRow()).getDescripcionArticulo());
            devolucion.setIdArticulo(listaPartidas.get(jTable1.getSelectedRow()).getIdArticulo());
            devolucion.setIdVenta(listaPartidas.get(jTable1.getSelectedRow()).getIdVenta());
            devolucion.setPrecioCompra(listaPartidas.get(jTable1.getSelectedRow()).getPrecioCompra());
            devolucion.setPrecioVenta(listaPartidas.get(jTable1.getSelectedRow()).getPrecioVenta());
            devolucion.setSubtotal(listaPartidas.get(jTable1.getSelectedRow()).getSubtotal());
            devolucion.setTipoBeneficio(listaPartidas.get(jTable1.getSelectedRow()).getTipoBeneficio());
            devolucion.setId(listaPartidas.get(jTable1.getSelectedRow()).getId());
            
            
            int numArticulos,numPartidas=0;
            double subTotal,total=0.0;
            
            numArticulos = this.devolucion.getArticulos() - listaPartidas.get(jTable1.getSelectedRow()).getCantidad();
            numPartidas = this.devolucion.getPartidas()-1;
            subTotal = this.devolucion.getSubtotal() - listaPartidas.get(jTable1.getSelectedRow()).getCantidad() * listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio();
            total = this.devolucion.getTotal() - listaPartidas.get(jTable1.getSelectedRow()).getCantidad() * listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio();
            
            this.devolucion.setArticulos(numArticulos);
            this.devolucion.setPartidas(numPartidas);
            this.devolucion.setSubtotal(subTotal);
            this.devolucion.setTotal(total);
            this.devolucion.setEstado("Devuelta");
            
          /*  ventadevuelta.setArticulos(ventadevuelta.getArticulos()+Integer.valueOf(jTextField1.getText()));
            ventadevuelta.setEstado("Devuelta");
            ventadevuelta.setIdadministrador(venta.getIdadministrador());
            ventadevuelta.setIdcliente(venta.getIdcliente()); 
            ventadevuelta.setIdusuario(venta.getIdusuario());
            ventadevuelta.setPartidas(ventadevuelta.getPartidas()+1);
            ventadevuelta.setSubtotal(ventadevuelta.getSubtotal()+ Integer.valueOf(jTextField1.getText()) * listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio());
            ventadevuelta.setTipoDeVenta(venta.getTipoDeVenta());
            ventadevuelta.setTotal(ventadevuelta.getTotal()+ Integer.valueOf(jTextField1.getText()) * listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio()); */
           this.ventadevuelta.setArticulos(this.ventadevuelta.getArticulos()+Integer.parseInt(jTextField1.getText()));
           this.ventadevuelta.setEstado("Devuelta");
           this.ventadevuelta.setPartidas(this.ventadevuelta.getPartidas()+1);
           this.ventadevuelta.setSubtotal(this.ventadevuelta.getSubtotal()+ Integer.valueOf(jTextField1.getText()) * listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio());
           this.ventadevuelta.setTotal(this.ventadevuelta.getTotal()+ Integer.valueOf(jTextField1.getText()) * listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio());
            
            jLabel4.setText(String.valueOf(numArticulos));
            jLabel6.setText(String.valueOf(numPartidas));
            jLabel8.setText(String.valueOf(subTotal));
            jLabel10.setText(String.valueOf(total));
           
            
            listaDevoluciones.add(devolucion);
            listaBorrar.add(listaPartidas.get(jTable1.getSelectedRow()));
            listaPartidas.remove(jTable1.getSelectedRow());
            dtm.removeRow(jTable1.getSelectedRow());
            jTable1.setModel(dtm);
            

            
        }else
        {
           int cantidad = listaPartidas.get(jTable1.getSelectedRow()).getCantidad() - Integer.parseInt(jTextField1.getText());
            Partidasdevoluciones devolucion = new Partidasdevoluciones();
            devolucion.setBeneficio(listaPartidas.get(jTable1.getSelectedRow()).getBeneficio());
            devolucion.setCantidad(Integer.parseInt(jTextField1.getText()));
            devolucion.setCodigoArticulo(listaPartidas.get(jTable1.getSelectedRow()).getCodigoArticulo());
            devolucion.setConBeneficio(listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio());
            devolucion.setDescripcionArticulo(listaPartidas.get(jTable1.getSelectedRow()).getDescripcionArticulo());
            devolucion.setIdArticulo(listaPartidas.get(jTable1.getSelectedRow()).getIdArticulo());
            devolucion.setIdVenta(listaPartidas.get(jTable1.getSelectedRow()).getIdVenta());
            devolucion.setPrecioCompra(listaPartidas.get(jTable1.getSelectedRow()).getPrecioCompra());
            devolucion.setPrecioVenta(listaPartidas.get(jTable1.getSelectedRow()).getPrecioVenta());
            devolucion.setSubtotal(listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio() * devolucion.getCantidad());
            devolucion.setTipoBeneficio(listaPartidas.get(jTable1.getSelectedRow()).getTipoBeneficio());
            
            int numArticulos,numPartidas;
            double subTotal,total;
            
            numArticulos = this.devolucion.getArticulos() - Integer.parseInt(jTextField1.getText());
            numPartidas = this.devolucion.getPartidas();
            subTotal = this.devolucion.getSubtotal() - Integer.parseInt(jTextField1.getText()) * listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio();
            total = this.devolucion.getTotal() - Integer.parseInt(jTextField1.getText()) * listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio();
            
            this.devolucion.setArticulos(numArticulos);
            this.devolucion.setPartidas(numPartidas);
            this.devolucion.setSubtotal(subTotal);
            this.devolucion.setTotal(total);
            this.devolucion.setEstado("Devuelta");
            
           this.ventadevuelta.setArticulos(this.ventadevuelta.getArticulos()+Integer.parseInt(jTextField1.getText()));
           this.ventadevuelta.setEstado("Devuelta");
           this.ventadevuelta.setPartidas(this.ventadevuelta.getPartidas()+1);
           this.ventadevuelta.setSubtotal(this.ventadevuelta.getSubtotal()+ Integer.valueOf(jTextField1.getText()) * listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio());
           this.ventadevuelta.setTotal(this.ventadevuelta.getTotal()+ Integer.valueOf(jTextField1.getText()) * listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio());
            
            jLabel4.setText(String.valueOf(numArticulos));
            jLabel6.setText(String.valueOf(numPartidas));
            jLabel8.setText(String.valueOf(subTotal));
            jLabel10.setText(String.valueOf(total));
           
            
            listaDevoluciones.add(devolucion);
            listaPartidas.get(jTable1.getSelectedRow()).setCantidad(cantidad);
            listaPartidas.get(jTable1.getSelectedRow()).setSubtotal(cantidad*listaPartidas.get(jTable1.getSelectedRow()).getConBeneficio());
            
            dtm.setValueAt(cantidad, jTable1.getSelectedRow(), 4);
            dtm.setValueAt(listaPartidas.get(jTable1.getSelectedRow()).getSubtotal(), jTable1.getSelectedRow(), 5);
            jTable1.setModel(dtm);
        }   
                jButton5.setEnabled(true);
                jButton6.setEnabled(true);
                jButton8.setEnabled(false);
                jButton9.setEnabled(false);
                
        hCuentasPorCobrar hcc = new hCuentasPorCobrar();
            
        if(hcc.generarFecha().substring(0,9).equals(jLabel14.getText().substring(0, 9)))
            jButton5.setEnabled(false);
        else
            jButton6.setEnabled(false);
    }//GEN-LAST:event_jButton1ActionPerformed

    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed

        jButton1.setEnabled(true);
        jButton10.setEnabled(true);
        jButton7.setEnabled(true);
        jButton8.setEnabled(true);
        jButton9.setEnabled(true);
        jButton2.setEnabled(false);
        jTextField1.setEnabled(true);
        
            if(!CConfiguracion.isDevolverVentas())
        {
        jButton1.setEnabled(false);
        jButton8.setEnabled(false);
        jButton9.setEnabled(false);
        jButton7.setEnabled(false);
        }
    }//GEN-LAST:event_jButton2ActionPerformed

    private void jButton5ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton5ActionPerformed
        // TODO add your handling code here:
        try{
            
       boolean validar = false;     
       List<Ventas> nuevaVenta = hventas.consultaVentas("id", "=", String.valueOf(venta.getId()));
       
       if(Double.compare(nuevaVenta.get(0).getTotal(), comprobarCancelacion) != 0)
       {
        validar = true;   
       }
       
       
              
       if(validar)
       {
           JOptionPane.showMessageDialog(null, "Los datos han sido modificados en otra ventana, \n por favor cierrela, busque nuevamente la partida \n "
                   + "y realice la devolución");
           return;
       }
            
               
                ConexionWeb conexionweb = new ConexionWeb();
                String transaccion="";
            
               List<Partidas> impresionPartidas  = new ArrayList<Partidas>();
                
        
               VConfirmaAlmacenista confirmaalmacenista = new VConfirmaAlmacenista((JFrame)Window.getWindows()[0],true);
                confirmaalmacenista.setLocationRelativeTo(null);
                confirmaalmacenista.setVisible(true);
                
                if(confirmaalmacenista.isExito())
                {
                    
       if(!CPrincipal.getConexion().crearTransaccion())
       return;            
       
       if(CGlobalConfig.isWeb())
       transaccion = conexionweb.iniciarTransaccion() + " ";
                
        //actualizar las ventas
        this.devolucion.setEstado("DevueltaP");
        
       if(!CGlobalConfig.isWeb()) 
        hventas.actualizarVentasDev(devolucion, "id", "=", String.valueOf(devolucion.getId()));
       else
        transaccion = transaccion + hventas.crearQueryActualizarVentasDev(devolucion, "id", "=", String.valueOf(devolucion.getId())) + " ";   
        
        
        this.ventadevuelta.setObservaciones(jTextField2.getText());
        this.ventadevuelta.setCodigoVenta("v"+venta.getId());
        this.ventadevuelta.setIdVenta(venta.getId());
        this.ventadevuelta.setIdusuario(confirmaalmacenista.getIdalmacenista());
        this.ventadevuelta.setIdadministrador(confirmaalmacenista.getIdadministrador());
        this.ventadevuelta.setIdcliente(cliente.getId());
        this.ventadevuelta.setTipoDeVenta(venta.getTipoDeVenta());
        System.out.println("a"+this.ventadevuelta.getIdcliente());        
        
          int devolucionGuardada=0;
                if(!CGlobalConfig.isWeb())
                devolucionGuardada=hdevoluciones.guardarVentas(this.ventadevuelta);
                 else            
                  {
                transaccion = transaccion + hdevoluciones.crearQueryGuardarVentas(this.ventadevuelta) + " ";
                transaccion = transaccion + conexionweb.ultimoId() + " ";
                  }
        
        //actualizar y borrar partidas en la venta
        

            int o=0;
            while(o<listaPartidas.size())
            {
                    if(!CGlobalConfig.isWeb())
                    hpartidas.actualizarPartidas(listaPartidas.get(o), "id", "=", String.valueOf(listaPartidas.get(o).getId()));
                    else
                    transaccion = transaccion + hpartidas.crearQueryActualizarPartidas(listaPartidas.get(o), "id", "=", String.valueOf(listaPartidas.get(o).getId())) + " ";    
                o++;
            }
            int i=0;
            while(i<listaBorrar.size())
            {
                if(!CGlobalConfig.isWeb())
                hpartidas.borrarPartidas("id", "=", String.valueOf(listaBorrar.get(i).getId()));
                else
                transaccion = transaccion + hpartidas.crearQueryBorrarPartidas("id", "=", String.valueOf(listaBorrar.get(i).getId())) + " ";        
                i++;
            }

         
        //insertar devoluciones y guardar el kardex
            int a=0;
            while(a<listaDevoluciones.size())
            {   
                Kardex renglon=hkardex.consultaUltimoRenglon("articulo", "=", listaDevoluciones.get(a).getCodigoArticulo());
           
                
           listaDevoluciones.get(a).setIdVenta((long)devolucionGuardada);     
           int idArticulo = 0;
           if(!CGlobalConfig.isWeb())
           hpartidasdevoluciones.guardarPartidas(listaDevoluciones.get(a));
           else
           transaccion = transaccion + hpartidasdevoluciones.crearQueryGuardarPartidas(listaDevoluciones.get(a)) + " ";            

                almacendevoluciones.setBeneficio(listaDevoluciones.get(a).getBeneficio());     
           almacendevoluciones.setCantidad(listaDevoluciones.get(a).getCantidad());
           almacendevoluciones.setCodigoArticulo(listaDevoluciones.get(a).getCodigoArticulo());
           almacendevoluciones.setConBeneficio(listaDevoluciones.get(a).getConBeneficio());
           almacendevoluciones.setDescripcionArticulo(listaDevoluciones.get(a).getDescripcionArticulo());
           almacendevoluciones.setIdArticulo(listaDevoluciones.get(a).getIdArticulo());
           almacendevoluciones.setIdVenta(listaDevoluciones.get(a).getIdVenta());
           almacendevoluciones.setPrecioCompra(listaDevoluciones.get(a).getPrecioCompra());
           almacendevoluciones.setPrecioVenta(listaDevoluciones.get(a).getPrecioVenta());
           almacendevoluciones.setSubtotal(listaDevoluciones.get(a).getSubtotal());
           almacendevoluciones.setTipoBeneficio(listaDevoluciones.get(a).getTipoBeneficio());
           
           Partidas impresionpartida = new Partidas();
           impresionpartida.setDescripcionArticulo(listaDevoluciones.get(a).getDescripcionArticulo());
           impresionpartida.setCantidad(listaDevoluciones.get(a).getCantidad());
           impresionpartida.setCodigoArticulo(listaDevoluciones.get(a).getCodigoArticulo());
           impresionpartida.setSubtotal(listaDevoluciones.get(a).getSubtotal());
           impresionPartidas.add(impresionpartida);
           
           List<Articulos> carticulo = harticulos.consultaArticulos("codigo", "=", String.valueOf(listaDevoluciones.get(a).getCodigoArticulo()));
           //    if(!carticulo.isEmpty()&&carticulo.get(0).getPrecioCompra()==almacendevoluciones.getPrecioCompra() &&
           //       carticulo.get(0).getPrecioVenta()==almacendevoluciones.getPrecioVenta()) //si el precio de lo que se va a devolver son iguales a los que hay en el almacen principal
            if(!carticulo.isEmpty()
                &&Double.compare(carticulo.get(0).getPrecioCompra(), almacendevoluciones.getPrecioCompra())==0
           //   &&Double.compare(carticulo.get(0).getPrecioVenta(), almacendevoluciones.getPrecioVenta())==0    
                    )
           {                                                                          //el articulo se va a almacen principal, sino se va a devoluciones
                int nuevaExistencia = (int)carticulo.get(0).getExistencia() + almacendevoluciones.getCantidad(); //estas reglas se pueden aplicar para solo aceptar precios
           
                if(!CGlobalConfig.isWeb())     
                harticulos.actualizarExistencias(carticulo.get(0).getCodigo(), nuevaExistencia); //mayores o menores y mandarlos a devoluciones...
                else
                transaccion = transaccion + harticulos.crearQueryActualizarExistencias(carticulo.get(0).getCodigo(), nuevaExistencia) + " ";    
                
                if(renglon == null)
                {
                    //Se registra la pieza en Kardex
                    renglon = new Kardex();
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(carticulo.get(0).getAnticipos());
                    renglon.setArticulo(carticulo.get(0).getCodigo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)carticulo.get(0).getExistencia());
                    renglon.setIdArticulo(carticulo.get(0).getId());
                    renglon.setModificacion("Registro");
                    renglon.setMovimiento("Registro de Artículo");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(carticulo.get(0).getPrecioVenta());
                    renglon.setRefFerrari("Registro");
                    renglon.setReservados((int)carticulo.get(0).getReservado());
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(carticulo.get(0).getUltimoCosto());
                    renglon.setVendidoEn(0.0); 
                    
                if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(renglon); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";     
                    //19
                }
                
               }else
               {
               List<Almacendevoluciones> listaActualizar = halmacendevoluciones.consultaPartidas("codigoArticulo", "=", almacendevoluciones.getCodigoArticulo());
                   
               int indiceConocer = 0; 
               boolean bandera=true;
               while(indiceConocer<listaActualizar.size())
               {
            //       System.out.println("almacen " +almacendevoluciones.getCodigoArticulo() + "listaActualizar "+ listaActualizar.get(indiceConocer).getCodigoArticulo());
           //        System.out.println("almacen " +almacendevoluciones.getPrecioCompra() + "listaActualizar "+ listaActualizar.get(indiceConocer).getPrecioCompra());
           //        System.out.println("almacen " +almacendevoluciones.getPrecioVenta() + "listaActualizar "+ listaActualizar.get(indiceConocer).getPrecioVenta());
                   if(almacendevoluciones.getCodigoArticulo().equals(listaActualizar.get(indiceConocer).getCodigoArticulo())&&
                           Double.compare(almacendevoluciones.getPrecioCompra(),listaActualizar.get(indiceConocer).getPrecioCompra()) == 0&&
                           Double.compare(almacendevoluciones.getPrecioVenta(),listaActualizar.get(indiceConocer).getPrecioVenta()) == 0)
                   {
                   //    System.out.println("aaaaaa "+listaActualizar.get(indiceConocer).getId());
                       int nuevaCantidad = listaActualizar.get(indiceConocer).getCantidad() + almacendevoluciones.getCantidad();
                                             
                       if(!CGlobalConfig.isWeb())
                       {
                       halmacendevoluciones.actualizarExistencias(listaActualizar.get(indiceConocer).getId(), nuevaCantidad); 
                       harticulos.aumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), almacendevoluciones.getCantidad());
                       }else
                       {
                       transaccion = transaccion + halmacendevoluciones.crearQueryActualizarExistencias(listaActualizar.get(indiceConocer).getId(), nuevaCantidad) + " ";     
                       List<Articulos> artlos = harticulos.consultaArticulos("codigo", "=", almacendevoluciones.getCodigoArticulo());
                       int catalogo = artlos.get(0).getAlmacenDevoluciones();
                       int totalcantidad = catalogo + almacendevoluciones.getCantidad();
                       transaccion = transaccion + harticulos.crearQueryAumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), totalcantidad) + " ";     
                       }    
                       
                       indiceConocer = listaActualizar.size();
                       bandera = false;
                       
                       
                  if(renglon == null)
                {
                    //Se registra la pieza en Kardex
                    renglon = new Kardex();
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(0);
                    renglon.setArticulo(almacendevoluciones.getCodigoArticulo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)nuevaCantidad);
                    renglon.setIdArticulo(almacendevoluciones.getIdArticulo());
                    renglon.setModificacion("Registro Almacén Devoluciones");
                    renglon.setMovimiento("Registro de Artículo AD");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(almacendevoluciones.getPrecioVenta());
                    renglon.setRefFerrari("AD Registro");
                    renglon.setReservados(0);
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático AD");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(almacendevoluciones.getPrecioCompra());
                    renglon.setVendidoEn(0.0); 
                    
                if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(renglon); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";   
                    //19
                } 
                       
                   }
 
                   indiceConocer++;
               }
                   
               if(bandera)
               {
                if(renglon == null)
                {  
                    renglon = new Kardex();
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(0);
                    renglon.setArticulo(almacendevoluciones.getCodigoArticulo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)almacendevoluciones.getCantidad());
                    renglon.setIdArticulo(almacendevoluciones.getIdArticulo());
                    renglon.setModificacion("Registro Almacén Devoluciones");
                    renglon.setMovimiento("Registro de Artículo AD");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(almacendevoluciones.getPrecioVenta());
                    renglon.setRefFerrari("AD Registro");
                    renglon.setReservados(0);
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático AD");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(almacendevoluciones.getPrecioCompra());
                    renglon.setVendidoEn(0.0); 
                    
                if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(renglon); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";   
                            }
                           
               if(!CGlobalConfig.isWeb())
               {
               halmacendevoluciones.guardarPartidas(almacendevoluciones);   
               harticulos.aumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), almacendevoluciones.getCantidad());
               }
              else
              {
             transaccion = transaccion + halmacendevoluciones.crearQueryGuardarPartidas(almacendevoluciones) + " ";     
             List<Articulos> artlos = harticulos.consultaArticulos("codigo", "=", almacendevoluciones.getCodigoArticulo());
             int catalogo = artlos.get(0).getAlmacenDevoluciones();
             int totalcantidad = catalogo + almacendevoluciones.getCantidad();
             transaccion = transaccion + harticulos.crearQueryAumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), totalcantidad) + " ";     
               }
               
               
               }
               }
                
           
               
            Kardex kardex = new Kardex();
            kardex.setAlmacenista("");
            kardex.setArticulo(listaDevoluciones.get(a).getCodigoArticulo());
            kardex.setEntrada((int)listaDevoluciones.get(a).getCantidad());
           // kardex.setIdArticulo(idArticulo); carticulo.get(0).getId()
            kardex.setIdArticulo(carticulo.get(0).getId());
            kardex.setExistencias(renglon.getExistencias()+(int)listaDevoluciones.get(a).getCantidad());
            kardex.setModificacion("Devolución Artículo");
            kardex.setMovimiento("Devolución Artículo");
            String nomov = String.valueOf(Integer.parseInt(renglon.getNoMov()) + 1);
            kardex.setNoMov(nomov); 
            kardex.setPrecioVenta(listaDevoluciones.get(a).getPrecioVenta());
            kardex.setRefFerrari("V"+String.valueOf(this.venta.getId())); 
            kardex.setReservados(renglon.getReservados()); 
            kardex.setAnticipos(renglon.getAnticipos());
            kardex.setResponsable(String.valueOf(CConfiguracion.getId())); //para saber quién hizo la devolución
            kardex.setSalida(0); //no hay artículos en salida pues es una devolución
            kardex.setUltimoCosto(listaDevoluciones.get(a).getPrecioCompra());
            kardex.setVendidoEn(0.0);
            kardex.setResponsable2(confirmaalmacenista.getNombreAdministrador());
            
            if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(kardex); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(kardex) + " ";    
            
                a++;
            }
        
        hCuentasPorCobrar hcc = new hCuentasPorCobrar();
        if(jLabel12.getText().equalsIgnoreCase("Credito"))
        {
        
        List <Cuentasporcobrar> cc = hcc.consultaCtaPorCobrar("venta", "=", jLabel2.getText());
        if(!cc.isEmpty())
        {
        cc.get(0).setSaldo(Double.valueOf(jLabel10.getText()));
        
        if(!CGlobalConfig.isWeb())
        hcc.actualizarCtaPorCobrar(cc.get(0), "id", "=", String.valueOf(cc.get(0).getId()));    
        else
        transaccion = transaccion + hcc.crearQueryActualizarCtaPorCobrar(cc.get(0), "id", "=", String.valueOf(cc.get(0).getId())) + " ";    
                
        }
        }

        CPrincipal.getConexion().finalizarTransaccion();
        
         if(CGlobalConfig.isWeb())
               {
               transaccion = transaccion + conexionweb.finalizarTransaccion();    
               conexionweb.escribirEnWeb(transaccion);
               }
            
            //falta la impresión
        jLabel34.setText("Devuelta");
        
                try {
        ImpresionDevolucionCaja idc = new ImpresionDevolucionCaja();
        idc.inicializar(String.valueOf(venta.getId()), jLabel30.getText(), jLabel4.getText(), 
                                       confirmaalmacenista.getNombreAdministrador(), hcc.generarFecha().substring(0, 20), impresionPartidas, 
                                       jLabel12.getText(), jLabel8.getText(), jLabel10.getText(), 
                                       String.valueOf(0), jTextField2.getText(),"DEVOLUCIÓN");
         PrinterJob job = PrinterJob.getPrinterJob();
         // job.setPrintable(idc);
        // PageFormat format = job.pageDialog(job.defaultPage());
        
        PageFormat format = new PageFormat();
        
        
        Paper p = new Paper();
        
        p.setSize(CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        p.setImageableArea(CGlobalConfig.getxImp(),CGlobalConfig.getyImp(),CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        format.setPaper(p);
         
        job.setPageable(new PageableText(idc.generarCadenaImpresion(), format));
        
         if (job.printDialog())
         job.print();
         }  catch (IOException ex) {
                Logger.getLogger(VDetalle_Ventas.class.getName()).log(Level.SEVERE, null, ex);
            } catch (PrinterException ex) {
            Logger.getLogger(ImpresionVenta.class.getName()).log(Level.SEVERE, null, ex);
        }
        
        try {
        ImpresionCancelacionAlmacen ica = new ImpresionCancelacionAlmacen();
        ica.inicializar(String.valueOf(venta.getId()), jLabel30.getText(), jLabel4.getText(), 
                                       confirmaalmacenista.getNombreAdministrador(), hcc.generarFecha().substring(0, 20), impresionPartidas, 
                                       jLabel12.getText(), jTextField2.getText(), confirmaalmacenista.getAlmacenista(),"DEVOLUCIÓN");
         PrinterJob job = PrinterJob.getPrinterJob();
        // PageFormat format = job.pageDialog(job.defaultPage());
         
        PageFormat format = new PageFormat();
        
        
        Paper p = new Paper();
        
        p.setSize(CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        p.setImageableArea(CGlobalConfig.getxImp(),CGlobalConfig.getyImp(),CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        format.setPaper(p); 
         
        job.setPageable(new PageableText(ica.generarCadenaImpresion(), format));
        // job.setPrintable(ica);
         if (job.printDialog())
         job.print();
         }  catch (IOException ex) {
                Logger.getLogger(VDetalle_Ventas.class.getName()).log(Level.SEVERE, null, ex);
            } catch (PrinterException ex) {
            Logger.getLogger(ImpresionVenta.class.getName()).log(Level.SEVERE, null, ex);
        }
        
        JOptionPane.showMessageDialog(null, "Devolución Parcial Efectuada");
        
        jButton8.setEnabled(false);
        jButton9.setEnabled(false);
        jButton5.setEnabled(false);
        jButton6.setEnabled(false);
        
                }
                }catch(Exception e)
        {
            CPrincipal.getConexion().cancelarTransaccion();
            e.printStackTrace();            
        }
    }//GEN-LAST:event_jButton5ActionPerformed

    private void jButton6ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton6ActionPerformed
        // TODO add your handling code here:
        try{
            
       boolean validar = false;     
       List<Ventas> nuevaVenta = hventas.consultaVentas("id", "=", String.valueOf(venta.getId()));
       
       if(Double.compare(nuevaVenta.get(0).getTotal(), comprobarCancelacion) != 0)
       {
        validar = true;   
       }
       
       
              
       if(validar)
       {
           JOptionPane.showMessageDialog(null, "Los datos han sido modificados en otra ventana, \n por favor cierrela, busque nuevamente la partida \n "
                   + "y realice la devolución");
           return;
       }
            

                ConexionWeb conexionweb = new ConexionWeb();
                String transaccion="";
            
              List<Partidas> impresionPartidas  = new ArrayList<Partidas>();  
                
               VConfirmaAlmacenista confirmaalmacenista = new VConfirmaAlmacenista((JFrame)Window.getWindows()[0],true);
                confirmaalmacenista.setLocationRelativeTo(null);
                confirmaalmacenista.setVisible(true);
                
                if(confirmaalmacenista.isExito())
                {
                    
        if(!CPrincipal.getConexion().crearTransaccion())
        return;            
        
        if(CGlobalConfig.isWeb())
       transaccion = conexionweb.iniciarTransaccion() + " ";
                
        //actualizar las ventas
        this.devolucion.setEstado("DevueltaP");
        
       if(!CGlobalConfig.isWeb()) 
        hventas.actualizarVentasDev(devolucion, "id", "=", String.valueOf(devolucion.getId()));
       else
        transaccion = transaccion + hventas.crearQueryActualizarVentasDev(devolucion, "id", "=", String.valueOf(devolucion.getId())) + " ";   
        
        
        
        this.ventadevuelta.setObservaciones(jTextField2.getText());
        this.ventadevuelta.setCodigoVenta("v"+venta.getId());
        this.ventadevuelta.setIdVenta(venta.getId());
        this.ventadevuelta.setIdusuario(confirmaalmacenista.getIdalmacenista());
        this.ventadevuelta.setIdadministrador(confirmaalmacenista.getIdadministrador());
        this.ventadevuelta.setIdcliente(cliente.getId());
        this.ventadevuelta.setTipoDeVenta(venta.getTipoDeVenta());
       // System.out.println("a"+this.ventadevuelta.getIdcliente());
        
        
        
          int devolucionGuardada=0;
                if(!CGlobalConfig.isWeb())
                devolucionGuardada=hdevoluciones.guardarVentas(this.ventadevuelta);
                 else            
                  {
                transaccion = transaccion + hdevoluciones.crearQueryGuardarVentas(this.ventadevuelta) + " ";
                transaccion = transaccion + conexionweb.ultimoId() + " ";
                  }
        
        //actualizar y borrar partidas en la venta
        

            int o=0;
            while(o<listaPartidas.size())
            {
                    if(!CGlobalConfig.isWeb())
                    hpartidas.actualizarPartidas(listaPartidas.get(o), "id", "=", String.valueOf(listaPartidas.get(o).getId()));
                    else
                    transaccion = transaccion + hpartidas.crearQueryActualizarPartidas(listaPartidas.get(o), "id", "=", String.valueOf(listaPartidas.get(o).getId())) + " ";    
                o++;
            }
            int i=0;
            while(i<listaBorrar.size())
            {
                if(!CGlobalConfig.isWeb())
                hpartidas.borrarPartidas("id", "=", String.valueOf(listaBorrar.get(i).getId()));
                else
                transaccion = transaccion + hpartidas.crearQueryBorrarPartidas("id", "=", String.valueOf(listaBorrar.get(i).getId())) + " ";        
                i++;
            }

         
        //insertar devoluciones y guardar el kardex
            int a=0;
            while(a<listaDevoluciones.size())
            {   
           Kardex renglon=hkardex.consultaUltimoRenglon("articulo", "=", listaDevoluciones.get(a).getCodigoArticulo());
           
           listaDevoluciones.get(a).setIdVenta((long)devolucionGuardada);     
                     
           int idArticulo = 0;
           if(!CGlobalConfig.isWeb())
           hpartidasdevoluciones.guardarPartidas(listaDevoluciones.get(a));
           else
           transaccion = transaccion + hpartidasdevoluciones.crearQueryGuardarPartidas(listaDevoluciones.get(a)) + " ";   

           almacendevoluciones.setBeneficio(listaDevoluciones.get(a).getBeneficio());     
           almacendevoluciones.setCantidad(listaDevoluciones.get(a).getCantidad());
           almacendevoluciones.setCodigoArticulo(listaDevoluciones.get(a).getCodigoArticulo());
           almacendevoluciones.setConBeneficio(listaDevoluciones.get(a).getConBeneficio());
           almacendevoluciones.setDescripcionArticulo(listaDevoluciones.get(a).getDescripcionArticulo());
           almacendevoluciones.setIdArticulo(listaDevoluciones.get(a).getIdArticulo());
           almacendevoluciones.setIdVenta(listaDevoluciones.get(a).getIdVenta());
           almacendevoluciones.setPrecioCompra(listaDevoluciones.get(a).getPrecioCompra());
           almacendevoluciones.setPrecioVenta(listaDevoluciones.get(a).getPrecioVenta());
           almacendevoluciones.setSubtotal(listaDevoluciones.get(a).getSubtotal());
           almacendevoluciones.setTipoBeneficio(listaDevoluciones.get(a).getTipoBeneficio());
           
           
           
           Partidas impresionpartida = new Partidas();
           impresionpartida.setDescripcionArticulo(listaDevoluciones.get(a).getDescripcionArticulo());
           impresionpartida.setCantidad(listaDevoluciones.get(a).getCantidad());
           impresionpartida.setCodigoArticulo(listaDevoluciones.get(a).getCodigoArticulo());
           impresionpartida.setSubtotal(listaDevoluciones.get(a).getSubtotal());
           impresionPartidas.add(impresionpartida);
           
           
           List<Articulos> carticulo = harticulos.consultaArticulos("id", "=", String.valueOf(listaDevoluciones.get(a).getIdArticulo()));
           //    if(!carticulo.isEmpty()&&carticulo.get(0).getPrecioCompra()==almacendevoluciones.getPrecioCompra() &&
           //       carticulo.get(0).getPrecioVenta()==almacendevoluciones.getPrecioVenta()) //si el precio de lo que se va a devolver son iguales a los que hay en el almacen principal
            if(!carticulo.isEmpty()
                &&Double.compare(carticulo.get(0).getPrecioCompra(), almacendevoluciones.getPrecioCompra())==0
           //   &&Double.compare(carticulo.get(0).getPrecioVenta(), almacendevoluciones.getPrecioVenta())==0
                    )
           {                                                                          //el articulo se va a almacen principal, sino se va a devoluciones
                int nuevaExistencia = (int)carticulo.get(0).getExistencia() + almacendevoluciones.getCantidad(); //estas reglas se pueden aplicar para solo aceptar precios
               
                
                if(!CGlobalConfig.isWeb())     
                harticulos.actualizarExistencias(carticulo.get(0).getCodigo(), nuevaExistencia); //mayores o menores y mandarlos a devoluciones...
                else
                transaccion = transaccion + harticulos.crearQueryActualizarExistencias(carticulo.get(0).getCodigo(), nuevaExistencia) + " ";    
                                    //Se registra la pieza en Kardex
                if(renglon==null)
                {
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(carticulo.get(0).getAnticipos());
                    renglon.setArticulo(carticulo.get(0).getCodigo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)carticulo.get(0).getExistencia());
                    renglon.setIdArticulo(carticulo.get(0).getId());
                    renglon.setModificacion("Registro");
                    renglon.setMovimiento("Registro de Artículo");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(carticulo.get(0).getPrecioVenta());
                    renglon.setRefFerrari("Registro");
                    renglon.setReservados((int)carticulo.get(0).getReservado());
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(carticulo.get(0).getUltimoCosto());
                    renglon.setVendidoEn(0.0);
                    
                if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(renglon); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";     
                    
                }
               }else
               {
               List<Almacendevoluciones> listaActualizar = halmacendevoluciones.consultaPartidas("codigoArticulo", "=", almacendevoluciones.getCodigoArticulo());
                   
               int indiceConocer = 0; 
               boolean bandera=true;
               while(indiceConocer<listaActualizar.size())
               {
            //       System.out.println("almacen " +almacendevoluciones.getCodigoArticulo() + "listaActualizar "+ listaActualizar.get(indiceConocer).getCodigoArticulo());
           //        System.out.println("almacen " +almacendevoluciones.getPrecioCompra() + "listaActualizar "+ listaActualizar.get(indiceConocer).getPrecioCompra());
           //        System.out.println("almacen " +almacendevoluciones.getPrecioVenta() + "listaActualizar "+ listaActualizar.get(indiceConocer).getPrecioVenta());
                   if(almacendevoluciones.getCodigoArticulo().equals(listaActualizar.get(indiceConocer).getCodigoArticulo())&&
                           Double.compare(almacendevoluciones.getPrecioCompra(),listaActualizar.get(indiceConocer).getPrecioCompra()) == 0&&
                           Double.compare(almacendevoluciones.getPrecioVenta(),listaActualizar.get(indiceConocer).getPrecioVenta()) == 0)
                   {
                   //    System.out.println("aaaaaa "+listaActualizar.get(indiceConocer).getId());
                       int nuevaCantidad = listaActualizar.get(indiceConocer).getCantidad() + almacendevoluciones.getCantidad();                  
                       
                       if(!CGlobalConfig.isWeb())
                       {
                       halmacendevoluciones.actualizarExistencias(listaActualizar.get(indiceConocer).getId(), nuevaCantidad); 
                       harticulos.aumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), almacendevoluciones.getCantidad());
                       }else
                       {
                       transaccion = transaccion + halmacendevoluciones.crearQueryActualizarExistencias(listaActualizar.get(indiceConocer).getId(), nuevaCantidad) + " ";     
                       List<Articulos> artlos = harticulos.consultaArticulos("codigo", "=", almacendevoluciones.getCodigoArticulo());
                       int catalogo = artlos.get(0).getAlmacenDevoluciones();
                       int totalcantidad = catalogo + almacendevoluciones.getCantidad();
                       transaccion = transaccion + harticulos.crearQueryAumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), totalcantidad) + " ";     
                       }    
                       
                       indiceConocer = listaActualizar.size();
                       bandera = false;
                       
                             if(renglon == null)
                {
                    //Se registra la pieza en Kardex
                    renglon = new Kardex();
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(0);
                    renglon.setArticulo(almacendevoluciones.getCodigoArticulo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)nuevaCantidad);
                    renglon.setIdArticulo(almacendevoluciones.getIdArticulo());
                    renglon.setModificacion("Registro Almacén Devoluciones");
                    renglon.setMovimiento("Registro de Artículo AD");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(almacendevoluciones.getPrecioVenta());
                    renglon.setRefFerrari("AD Registro");
                    renglon.setReservados(0);
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático AD");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(almacendevoluciones.getPrecioCompra());
                    renglon.setVendidoEn(0.0); 
                    
                if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(renglon); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";   
                    //19
                } 
                   }
 
                   indiceConocer++;
               }
                   
               if(bandera)
               {
                   
               if(!CGlobalConfig.isWeb())
               {
               halmacendevoluciones.guardarPartidas(almacendevoluciones);   
               harticulos.aumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), almacendevoluciones.getCantidad());
               }
              else
              {
             transaccion = transaccion + halmacendevoluciones.crearQueryGuardarPartidas(almacendevoluciones) + " ";     
             List<Articulos> artlos = harticulos.consultaArticulos("codigo", "=", almacendevoluciones.getCodigoArticulo());
             int catalogo = artlos.get(0).getAlmacenDevoluciones();
             int totalcantidad = catalogo + almacendevoluciones.getCantidad();
             transaccion = transaccion + harticulos.crearQueryAumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), totalcantidad) + " ";     
               }
               
               if(renglon == null)
                {  
                    renglon = new Kardex();
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(0);
                    renglon.setArticulo(almacendevoluciones.getCodigoArticulo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)almacendevoluciones.getCantidad());
                    renglon.setIdArticulo(almacendevoluciones.getIdArticulo());
                    renglon.setModificacion("Registro Almacén Devoluciones");
                    renglon.setMovimiento("Registro de Artículo AD");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(almacendevoluciones.getPrecioVenta());
                    renglon.setRefFerrari("AD Registro");
                    renglon.setReservados(0);
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático AD");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(almacendevoluciones.getPrecioCompra());
                    renglon.setVendidoEn(0.0); 
                    
                if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(renglon); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";    
                    
                            }
               
               }
               }
                
           
               
            Kardex kardex = new Kardex();
            kardex.setAlmacenista("");
            kardex.setArticulo(listaDevoluciones.get(a).getCodigoArticulo());
            kardex.setEntrada((int)listaDevoluciones.get(a).getCantidad());
            kardex.setIdArticulo(carticulo.get(0).getId()); 
            kardex.setExistencias(renglon.getExistencias()+(int)listaDevoluciones.get(a).getCantidad());
            kardex.setModificacion("Cancelación Artículo");
            kardex.setMovimiento("Cancelación Artículo");
            String nomov = String.valueOf(Integer.parseInt(renglon.getNoMov()) + 1);
            kardex.setNoMov(nomov); 
            kardex.setPrecioVenta(listaDevoluciones.get(a).getPrecioVenta());
            kardex.setRefFerrari("V"+String.valueOf(this.venta.getId())); 
            kardex.setReservados(renglon.getReservados()); 
            kardex.setAnticipos(renglon.getAnticipos());
            kardex.setResponsable(String.valueOf(CConfiguracion.getId())); //para saber quién hizo la devolución
            kardex.setSalida(0); //no hay artículos en salida pues es una devolución
            kardex.setUltimoCosto(listaDevoluciones.get(a).getPrecioCompra());
            kardex.setVendidoEn(0.0);
            kardex.setResponsable2(confirmaalmacenista.getNombreAdministrador());
           
            if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(kardex); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(kardex) + " ";    
            
            
                a++;
            }
        
        hCuentasPorCobrar hcc = new hCuentasPorCobrar();    
        if(jLabel12.getText().equalsIgnoreCase("Credito"))
        {
        List <Cuentasporcobrar> cc = hcc.consultaCtaPorCobrar("venta", "=", jLabel2.getText());
        if(!cc.isEmpty())
        {
        cc.get(0).setSaldo(Double.valueOf(jLabel10.getText()));
                
        if(!CGlobalConfig.isWeb())
        hcc.actualizarCtaPorCobrar(cc.get(0), "id", "=", String.valueOf(cc.get(0).getId()));    
        else
        transaccion = transaccion + hcc.crearQueryActualizarCtaPorCobrar(cc.get(0), "id", "=", String.valueOf(cc.get(0).getId())) + " ";    
        
        }
        }
        CPrincipal.getConexion().finalizarTransaccion();
        
          if(CGlobalConfig.isWeb())
               {
               transaccion = transaccion + conexionweb.finalizarTransaccion();    
               conexionweb.escribirEnWeb(transaccion);
               }
        
            //falta la impresión
        jLabel34.setText("Devuelta");
        
        try {
        ImpresionDevolucionCaja idc = new ImpresionDevolucionCaja();
        idc.inicializar(String.valueOf(venta.getId()), jLabel30.getText(), jLabel4.getText(), 
                                       confirmaalmacenista.getNombreAdministrador(), hcc.generarFecha().substring(0, 20), impresionPartidas, 
                                       jLabel12.getText(), jLabel8.getText(), jLabel10.getText(), 
                                       String.valueOf(0), jTextField2.getText(),"CANCELACIÓN");
         PrinterJob job = PrinterJob.getPrinterJob();
        // job.setPrintable(idc);
        // PageFormat format = job.pageDialog(job.defaultPage());
         
        PageFormat format = new PageFormat();
        
        
        Paper p = new Paper();
        
        p.setSize(CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        p.setImageableArea(CGlobalConfig.getxImp(),CGlobalConfig.getyImp(),CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        format.setPaper(p);  
         
        job.setPageable(new PageableText(idc.generarCadenaImpresion(), format));
         if (job.printDialog())
         job.print();
         }  catch (IOException ex) {
                Logger.getLogger(VDetalle_Ventas.class.getName()).log(Level.SEVERE, null, ex);
            } catch (PrinterException ex) {
            Logger.getLogger(ImpresionVenta.class.getName()).log(Level.SEVERE, null, ex);
        }
        
        try {
        ImpresionCancelacionAlmacen ica = new ImpresionCancelacionAlmacen();
        ica.inicializar(String.valueOf(venta.getId()), jLabel30.getText(), jLabel4.getText(), 
                                       confirmaalmacenista.getNombreAdministrador(), hcc.generarFecha().substring(0, 20), impresionPartidas, 
                                       jLabel12.getText(), jTextField2.getText(), confirmaalmacenista.getAlmacenista(),"CANCELACIÓN");
         PrinterJob job = PrinterJob.getPrinterJob();
        // PageFormat format = job.pageDialog(job.defaultPage());
         
        PageFormat format = new PageFormat();
        
        
        Paper p = new Paper();
        
        p.setSize(CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        p.setImageableArea(CGlobalConfig.getxImp(),CGlobalConfig.getyImp(),CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        format.setPaper(p); 
         
        job.setPageable(new PageableText(ica.generarCadenaImpresion(), format));
         // job.setPrintable(ica);
         if (job.printDialog())
         job.print();
         }  catch (IOException ex) {
                Logger.getLogger(VDetalle_Ventas.class.getName()).log(Level.SEVERE, null, ex);
            } catch (PrinterException ex) {
            Logger.getLogger(ImpresionVenta.class.getName()).log(Level.SEVERE, null, ex);
        }
        
        
        JOptionPane.showMessageDialog(null, "Cancelación Parcial Efectuada");
        
        jButton8.setEnabled(false);
        jButton9.setEnabled(false);
        jButton5.setEnabled(false);
        jButton6.setEnabled(false);
        
                }
        }catch(Exception e)
        {
            CPrincipal.getConexion().cancelarTransaccion();
            e.printStackTrace();            
        }
    }//GEN-LAST:event_jButton6ActionPerformed

    private void jButton7ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton7ActionPerformed
        // TODO add your handling code here:
       if(jLabel34.getText().equals("Devuelta"))
        {
            JOptionPane.showMessageDialog(null, "Lo siento, no se pueden deshacer cambios si la venta ya ha sido devuelta");
            return;
        } 
      
      
    //  devolucion = cancelar;
    //  this.venta = cancelar;
      
      
       jLabel20.setText(usuario.getFoto());
       jLabel21.setText(usuario.getNombres()+" "+usuario.getApellidoP()+" "+usuario.getApellidoM());
       jLabel22.setText(usuario.getPuesto());
       
        
       if(venta.getIdadministrador() == -1)
       {
       jLabel26.setText("");
       jLabel27.setText("Venta sin Administrador");
       jLabel28.setText("");
       } else
       {jLabel26.setText(administrador.getFoto());
       jLabel27.setText(administrador.getNombres()+" "+administrador.getApellidoP()+" "+administrador.getApellidoM());
       jLabel28.setText(administrador.getPuesto());
       }
       
      jLabel30.setText(cliente.getNombre());
      jLabel32.setText(cliente.getRfc());
       
         vector = new Vector();
         listaPartidas = hpartidas.consultaPartidas("idVenta", "=", String.valueOf(venta.getId()));
      for(Object o: listaPartidas){
             Partidas ipartidas = (Partidas)o;
             Vector<Object> unaFila = new Vector<Object>();
             unaFila.add(ipartidas.getCodigoArticulo());
             unaFila.add(ipartidas.getDescripcionArticulo());
             unaFila.add(ipartidas.getCantidad());
             unaFila.add(ipartidas.getPrecioCompra());
             unaFila.add(ipartidas.getPrecioVenta());
             unaFila.add(ipartidas.getTipoBeneficio());
             unaFila.add(ipartidas.getBeneficio());
             unaFila.add(ipartidas.getConBeneficio());
             unaFila.add(ipartidas.getSubtotal());
             vector.add(unaFila);

         }
           dtm = new DefaultTableModel(vector,encabezadoPartidas) {

              @Override
              public boolean isCellEditable(int row, int column) {
              return false;
                }
              };
           
           
           
          jTable1.setModel(dtm);
          jTable1.getSelectionModel().setSelectionInterval(0, 0);
          
             jLabel2.setText(String.valueOf(this.cancelar.getId()));
      jLabel4.setText(String.valueOf(this.cancelar.getArticulos()));
      jLabel6.setText(String.valueOf(this.cancelar.getPartidas()));
      jLabel8.setText(String.valueOf(this.cancelar.getSubtotal()));
      jLabel10.setText(String.valueOf(this.cancelar.getTotal()));
      jLabel12.setText(this.cancelar.getTipoDeVenta());
      jLabel14.setText(this.cancelar.getFechaVenta());
      jLabel16.setText(this.cancelar.getObservaciones());
      jLabel34.setText(this.cancelar.getEstado());
      jTextField2.setEditable(false);  
      

      devolucion.setArticulos(this.cancelar.getArticulos());
      devolucion.setEstado(this.cancelar.getEstado());
      devolucion.setFechaVenta(this.cancelar.getFechaVenta());
      devolucion.setId(this.cancelar.getId());
      devolucion.setIdadministrador(this.cancelar.getIdadministrador());
      devolucion.setIdcliente(this.cancelar.getIdcliente());
      devolucion.setIdusuario(this.cancelar.getIdusuario());
      devolucion.setObservaciones(this.cancelar.getObservaciones());
      devolucion.setPartidas(this.cancelar.getPartidas());
      devolucion.setSubtotal(this.cancelar.getSubtotal());
      devolucion.setTipoDeVenta(this.cancelar.getTipoDeVenta());
      devolucion.setTotal(this.cancelar.getTotal());
       
      listaDevoluciones.clear();
      listaBorrar.clear();
      
    }//GEN-LAST:event_jButton7ActionPerformed

    private void jButton8ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton8ActionPerformed
        // TODO add your handling code here:
        try{
        
        
    /*            if(jLabel34.getText().equals("Devuelta")||jLabel34.getText().equals("DevueltaP"))
        {
            JOptionPane.showMessageDialog(null, "Esta Venta ya ha sido devuelta");
            return;
        }  */
            
        boolean validar = false;     
       List<Ventas> nuevaVenta = hventas.consultaVentas("id", "=", String.valueOf(venta.getId()));
       
       if(Double.compare(nuevaVenta.get(0).getTotal(), comprobarCancelacion) != 0)
       {
        validar = true;   
       }
       
       
              
       if(validar)
       {
           JOptionPane.showMessageDialog(null, "Los datos han sido modificados en otra ventana, \n por favor cierrela, busque nuevamente la partida \n "
                   + "y realice la devolución");
           return;
       }
            
              
                ConexionWeb conexionweb = new ConexionWeb();
                String transaccion="";
            
                VConfirmaAlmacenista confirmaalmacenista = new VConfirmaAlmacenista((JFrame)Window.getWindows()[0],true);
                confirmaalmacenista.setLocationRelativeTo(null);
                confirmaalmacenista.setVisible(true);
                
                if(confirmaalmacenista.isExito())
                {
                
                if(!CPrincipal.getConexion().crearTransaccion())
                return;
                
            if(CGlobalConfig.isWeb())
            transaccion = conexionweb.iniciarTransaccion() + " ";
                
                ventadevuelta.setArticulos(venta.getArticulos()); 
                ventadevuelta.setEstado(venta.getEstado());
                ventadevuelta.setIdusuario(confirmaalmacenista.getIdalmacenista());
                ventadevuelta.setIdadministrador(confirmaalmacenista.getIdadministrador());
                ventadevuelta.setIdcliente(venta.getIdcliente());
                ventadevuelta.setObservaciones(venta.getObservaciones());
                ventadevuelta.setPartidas(venta.getPartidas());
                ventadevuelta.setSubtotal(venta.getSubtotal());
                ventadevuelta.setTipoDeVenta(venta.getTipoDeVenta());
                ventadevuelta.setTotal(venta.getTotal());
                ventadevuelta.setIdVenta(venta.getId());
                ventadevuelta.setCodigoVenta("v"+venta.getId());
                ventadevuelta.setObservaciones(jTextField2.getText());
                
                int devolucionGuardada=0;
                if(!CGlobalConfig.isWeb())
                devolucionGuardada=hdevoluciones.guardarVentas(ventadevuelta);
                 else            
                  {
                transaccion = transaccion + hdevoluciones.crearQueryGuardarVentas(ventadevuelta) + " ";
                transaccion = transaccion + conexionweb.ultimoId() + " ";
                  }
                    
 
                int i=0;
                while(i<listaPartidasVentas.size())
                {
                    Kardex renglon=hkardex.consultaUltimoRenglon("articulo", "=", listaPartidasVentas.get(i).getCodigoArticulo());
                    listaPartidasVentas.get(i).setIdVenta((long)devolucionGuardada);
                    Partidasdevoluciones partidaDevolucion = new Partidasdevoluciones();
                    partidaDevolucion.setBeneficio(listaPartidasVentas.get(i).getBeneficio()); 
                    partidaDevolucion.setCantidad(listaPartidasVentas.get(i).getCantidad());
                    partidaDevolucion.setCodigoArticulo(listaPartidasVentas.get(i).getCodigoArticulo());
                    partidaDevolucion.setDescripcionArticulo(listaPartidasVentas.get(i).getDescripcionArticulo());
                    partidaDevolucion.setIdArticulo(listaPartidasVentas.get(i).getIdArticulo());
                    partidaDevolucion.setIdCompleto(listaPartidasVentas.get(i).getIdCompleto());
                    partidaDevolucion.setIdVenta(listaPartidasVentas.get(i).getIdVenta());
                    partidaDevolucion.setPrecioCompra(listaPartidasVentas.get(i).getPrecioCompra());
                    partidaDevolucion.setPrecioVenta(listaPartidasVentas.get(i).getPrecioVenta());
                    partidaDevolucion.setSubtotal(listaPartidasVentas.get(i).getSubtotal());
                    partidaDevolucion.setTipoBeneficio(listaPartidasVentas.get(i).getTipoBeneficio());
                    partidaDevolucion.setUbicacion(listaPartidasVentas.get(i).getUbicacion());
                    partidaDevolucion.setConBeneficio(listaPartidasVentas.get(i).getConBeneficio());
                    
                    if(!CGlobalConfig.isWeb())
                    hpartidasdevoluciones.guardarPartidas(partidaDevolucion);
                    else
                    transaccion = transaccion + hpartidasdevoluciones.crearQueryGuardarPartidas(partidaDevolucion) + " ";    
                    
                //    Almacendevoluciones almacendevoluciones = new Almacendevoluciones();
                    almacendevoluciones.setBeneficio(listaPartidasVentas.get(i).getBeneficio());
                    almacendevoluciones.setCantidad(listaPartidasVentas.get(i).getCantidad());
                    almacendevoluciones.setCodigoArticulo(listaPartidasVentas.get(i).getCodigoArticulo());
                    almacendevoluciones.setConBeneficio(listaPartidasVentas.get(i).getConBeneficio());
                    almacendevoluciones.setDescripcionArticulo(listaPartidasVentas.get(i).getDescripcionArticulo());
                    almacendevoluciones.setExistenciaAlmacen(listaPartidasVentas.get(i).getCantidad());
                    almacendevoluciones.setIdArticulo(listaPartidasVentas.get(i).getIdArticulo());
                    almacendevoluciones.setIdVenta(listaPartidasVentas.get(i).getIdVenta());
                    almacendevoluciones.setIdCompleto(listaPartidasVentas.get(i).getIdCompleto());
                    almacendevoluciones.setPrecioCompra(listaPartidasVentas.get(i).getPrecioCompra());
                    almacendevoluciones.setPrecioVenta(listaPartidasVentas.get(i).getPrecioVenta());
                    almacendevoluciones.setSubtotal(listaPartidasVentas.get(i).getSubtotal());
                    almacendevoluciones.setTipoBeneficio(listaPartidasVentas.get(i).getTipoBeneficio());
                    
              List<Articulos> carticulo = harticulos.consultaArticulos("id", "=", String.valueOf(listaPartidasVentas.get(i).getIdArticulo()));
             if(!carticulo.isEmpty()
                &&Double.compare(carticulo.get(0).getPrecioCompra(), almacendevoluciones.getPrecioCompra())==0
             //   &&Double.compare(carticulo.get(0).getPrecioVenta(), almacendevoluciones.getPrecioVenta())==0
               )
              {                                                                          //el articulo se va a almacen principal, sino se va a devoluciones
                int nuevaExistencia = (int)carticulo.get(0).getExistencia() + almacendevoluciones.getCantidad(); //estas reglas se pueden aplicar para solo aceptar precios
                if(!CGlobalConfig.isWeb())
                harticulos.actualizarExistencias(carticulo.get(0).getCodigo(), nuevaExistencia); //mayores o menores y mandarlos a devoluciones...
                else
                transaccion = transaccion + harticulos.crearQueryActualizarExistencias(carticulo.get(0).getCodigo(), nuevaExistencia) + " ";    
                
                                if(renglon == null)
                {
                    //Se registra la pieza en Kardex
                    renglon = new Kardex();
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(carticulo.get(0).getAnticipos());
                    renglon.setArticulo(carticulo.get(0).getCodigo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)carticulo.get(0).getExistencia());
                    renglon.setIdArticulo(carticulo.get(0).getId());
                    renglon.setModificacion("Registro");
                    renglon.setMovimiento("Registro de Artículo");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(carticulo.get(0).getPrecioVenta());
                    renglon.setRefFerrari("Registro");
                    renglon.setReservados((int)carticulo.get(0).getReservado());
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(carticulo.get(0).getUltimoCosto());
                    renglon.setVendidoEn(0.0); 
                    
                if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(renglon); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";     
                    //19
                }
                
               }
             else
               {
               List<Almacendevoluciones> listaActualizar = halmacendevoluciones.consultaPartidas("codigoArticulo", "=", almacendevoluciones.getCodigoArticulo());
                   
               int indiceConocer = 0; 
               boolean bandera=true;
               while(indiceConocer<listaActualizar.size())
               {
             //      System.out.println("almacen " +almacendevoluciones.getCodigoArticulo() + "listaActualizar "+ listaActualizar.get(indiceConocer).getCodigoArticulo());
             //      System.out.println("almacen " +almacendevoluciones.getPrecioCompra() + "listaActualizar "+ listaActualizar.get(indiceConocer).getPrecioCompra());
             //      System.out.println("almacen " +almacendevoluciones.getPrecioVenta() + "listaActualizar "+ listaActualizar.get(indiceConocer).getPrecioVenta());
                   if(almacendevoluciones.getCodigoArticulo().equals(listaActualizar.get(indiceConocer).getCodigoArticulo())&&
                           Double.compare(almacendevoluciones.getPrecioCompra(),listaActualizar.get(indiceConocer).getPrecioCompra()) == 0&&
                           Double.compare(almacendevoluciones.getPrecioVenta(),listaActualizar.get(indiceConocer).getPrecioVenta()) == 0)
                   {
                   //    System.out.println("aaaaaa "+listaActualizar.get(indiceConocer).getId());
                       int nuevaCantidad = listaActualizar.get(indiceConocer).getCantidad() + almacendevoluciones.getCantidad();
                       if(!CGlobalConfig.isWeb())
                       {
                       halmacendevoluciones.actualizarExistencias(listaActualizar.get(indiceConocer).getId(), nuevaCantidad); 
                       harticulos.aumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), almacendevoluciones.getCantidad());
                       }else
                       {
                       transaccion = transaccion + halmacendevoluciones.crearQueryActualizarExistencias(listaActualizar.get(indiceConocer).getId(), nuevaCantidad) + " ";     
                       List<Articulos> artlos = harticulos.consultaArticulos("codigo", "=", almacendevoluciones.getCodigoArticulo());
                       int catalogo = artlos.get(0).getAlmacenDevoluciones();
                       int totalcantidad = catalogo + almacendevoluciones.getCantidad();
                       transaccion = transaccion + harticulos.crearQueryAumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), totalcantidad) + " ";     
                       }    
                       indiceConocer = listaActualizar.size();
                       bandera = false;
                       
                     if(renglon == null)
                {
                    //Se registra la pieza en Kardex
                    renglon = new Kardex();
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(0);
                    renglon.setArticulo(almacendevoluciones.getCodigoArticulo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)nuevaCantidad);
                    renglon.setIdArticulo(almacendevoluciones.getIdArticulo());
                    renglon.setModificacion("Registro Almacén Devoluciones");
                    renglon.setMovimiento("Registro de Artículo AD");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(almacendevoluciones.getPrecioVenta());
                    renglon.setRefFerrari("AD Registro");
                    renglon.setReservados(0);
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático AD");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(almacendevoluciones.getPrecioCompra());
                    renglon.setVendidoEn(0.0); 
                    
                if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(renglon); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";     
                    //19
                } 
                       
                   }
 
                   indiceConocer++;
               }
                   
               if(bandera)
               {
                   
               if(!CGlobalConfig.isWeb())
               {
               halmacendevoluciones.guardarPartidas(almacendevoluciones);   
               harticulos.aumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), almacendevoluciones.getCantidad());
               }
              else
              {
             transaccion = transaccion + halmacendevoluciones.crearQueryGuardarPartidas(almacendevoluciones) + " ";     
             List<Articulos> artlos = harticulos.consultaArticulos("codigo", "=", almacendevoluciones.getCodigoArticulo());
             int catalogo = artlos.get(0).getAlmacenDevoluciones();
             int totalcantidad = catalogo + almacendevoluciones.getCantidad();
             transaccion = transaccion + harticulos.crearQueryAumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), totalcantidad) + " ";     
               }    
               
               if(renglon == null)
                {  
                    renglon = new Kardex();
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(0);
                    renglon.setArticulo(almacendevoluciones.getCodigoArticulo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)almacendevoluciones.getCantidad());
                    renglon.setIdArticulo(almacendevoluciones.getIdArticulo());
                    renglon.setModificacion("Registro Almacén Devoluciones");
                    renglon.setMovimiento("Registro de Artículo AD");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(almacendevoluciones.getPrecioVenta());
                    renglon.setRefFerrari("AD Registro");
                    renglon.setReservados(0);
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático AD");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(almacendevoluciones.getPrecioCompra());
                    renglon.setVendidoEn(0.0); 
                
                if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(renglon); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";   
                            }
               
               }
               }
           //    if(!carticulo.isEmpty()&&carticulo.get(0).getPrecioCompra()==almacendevoluciones.getPrecioCompra() &&
           //       carticulo.get(0).getPrecioVenta()==almacendevoluciones.getPrecioVenta()) //si el precio de lo que se va a devolver son iguales a los que hay en el almacen principal
                    // halmacendevoluciones.guardarPartidas(partidaDevolucion);    
            
            Kardex kardex = new Kardex(); 
            kardex.setAlmacenista("");
            kardex.setArticulo(listaPartidasVentas.get(i).getCodigoArticulo());
            kardex.setEntrada((int)listaPartidasVentas.get(i).getCantidad());
            kardex.setIdArticulo(listaPartidasVentas.get(i).getIdArticulo()); 
            kardex.setExistencias(renglon.getExistencias()+(int)listaPartidasVentas.get(i).getCantidad());
            kardex.setModificacion("Devolución Artículo");
            kardex.setMovimiento("Devolución Artículo");
            String nomov = String.valueOf(Integer.parseInt(renglon.getNoMov()) + 1);
            kardex.setNoMov(nomov); 
            kardex.setPrecioVenta(listaPartidasVentas.get(i).getPrecioVenta());
            kardex.setRefFerrari("V"+String.valueOf(this.venta.getId())); 
            kardex.setReservados(renglon.getReservados()); 
            kardex.setAnticipos(renglon.getAnticipos());
            kardex.setResponsable(String.valueOf(CConfiguracion.getId())); //para saber quién hizo la devolución
            kardex.setSalida(0); //no hay artículos en salida pues es una devolución
            kardex.setUltimoCosto(listaPartidasVentas.get(i).getPrecioCompra());
            kardex.setVendidoEn(listaPartidasVentas.get(i).getConBeneficio());
            kardex.setResponsable2(confirmaalmacenista.getNombreAdministrador());
            
            if(!CGlobalConfig.isWeb())
            hkardex.guardarEnKardex(kardex); 
            else
            transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(kardex) + " ";   
             
             i++;       
                }
                
                for(int rows=dtm.getRowCount()-1; rows >= 0; rows--)
                {
                    dtm.removeRow(rows);
                }
                
                
                


                venta.setArticulos(0);
                venta.setEstado("Devuelta");
                venta.setPartidas(0);
                venta.setSubtotal((double)0);
                venta.setTotal((double)0);
                
                if(!CGlobalConfig.isWeb())
                {
                hventas.actualizarVentasDev(venta, "id", "=", String.valueOf(venta.getId()));
                hpartidas.borrarPartidas("idVenta","=", String.valueOf(venta.getId()));
                }else
                {
                transaccion = transaccion + hventas.crearQueryActualizarVentasDev(venta, "id", "=", String.valueOf(venta.getId())) + " "; 
                transaccion = transaccion + hpartidas.crearQueryBorrarPartidas("idVenta","=", String.valueOf(venta.getId())) + " "; 
                }
                
                      jLabel2.setText(String.valueOf(venta.getId()));
                      jLabel4.setText(String.valueOf(venta.getArticulos()));
                      jLabel6.setText(String.valueOf(venta.getPartidas()));
                      jLabel8.setText(String.valueOf(venta.getSubtotal()));
                      jLabel10.setText(String.valueOf(venta.getTotal()));
                      jLabel12.setText(venta.getTipoDeVenta());
                      jLabel14.setText(venta.getFechaVenta());
                      jLabel16.setText(venta.getObservaciones());
                      jLabel34.setText(venta.getEstado());
                      
                
                 jTable1.setModel(dtm);     
         
        hCuentasPorCobrar hcc = new hCuentasPorCobrar();
        
        if(jLabel12.getText().equalsIgnoreCase("Credito"))
        {
        if(!CGlobalConfig.isWeb())
        hcc.borrarCtaPorCobrar("venta", "=", jLabel2.getText());
        else
        transaccion = transaccion + hcc.crearQueryBorrarCtaPorCobrar("venta", "=", jLabel2.getText()) + " ";     
        }
        
        
        CPrincipal.getConexion().finalizarTransaccion();
        
        if(CGlobalConfig.isWeb())
               {
               transaccion = transaccion + conexionweb.finalizarTransaccion();    
               conexionweb.escribirEnWeb(transaccion);
               }
                 
              try {
        ImpresionDevolucionCaja idc = new ImpresionDevolucionCaja();
        idc.inicializar(String.valueOf(venta.getId()), jLabel30.getText(), jLabel4.getText(), 
                                       confirmaalmacenista.getNombreAdministrador(), hcc.generarFecha().substring(0, 20), listaPartidasVentas, 
                                       jLabel12.getText(), jLabel8.getText(), jLabel10.getText(), 
                                       String.valueOf(0), jTextField2.getText(),"DEVOLUCIÓN");
         PrinterJob job = PrinterJob.getPrinterJob();
        // PageFormat format = job.pageDialog(job.defaultPage());
         
        PageFormat format = new PageFormat();
        
        
        Paper p = new Paper();
        
        p.setSize(CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        p.setImageableArea(CGlobalConfig.getxImp(),CGlobalConfig.getyImp(),CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        format.setPaper(p);
         
        job.setPageable(new PageableText(idc.generarCadenaImpresion(), format));
         // job.setPrintable(idc);
         if (job.printDialog())
         job.print();
         }  catch (IOException ex) {
                Logger.getLogger(VDetalle_Ventas.class.getName()).log(Level.SEVERE, null, ex);
            } catch (PrinterException ex) {
            Logger.getLogger(ImpresionVenta.class.getName()).log(Level.SEVERE, null, ex);
        }
        
        try {
        ImpresionCancelacionAlmacen ica = new ImpresionCancelacionAlmacen();
        ica.inicializar(String.valueOf(venta.getId()), jLabel30.getText(), jLabel4.getText(), 
                                       confirmaalmacenista.getNombreAdministrador(), hcc.generarFecha().substring(0, 20), listaPartidasVentas, 
                                       jLabel12.getText(), jTextField2.getText(), confirmaalmacenista.getAlmacenista(),"DEVOLUCIÓN");
         PrinterJob job = PrinterJob.getPrinterJob();
        // job.setPrintable(ica);
        // PageFormat format = job.pageDialog(job.defaultPage());
         
        PageFormat format = new PageFormat();
        
        
        Paper p = new Paper();
        
        p.setSize(CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        p.setImageableArea(CGlobalConfig.getxImp(),CGlobalConfig.getyImp(),CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        format.setPaper(p); 
         
        job.setPageable(new PageableText(ica.generarCadenaImpresion(), format));
         if (job.printDialog())
         job.print();
         }  catch (IOException ex) {
                Logger.getLogger(VDetalle_Ventas.class.getName()).log(Level.SEVERE, null, ex);
            } catch (PrinterException ex) {
            Logger.getLogger(ImpresionVenta.class.getName()).log(Level.SEVERE, null, ex);
        }                  
        
        

        JOptionPane.showMessageDialog(null, "Devolución Completa Efectuada");
        jButton8.setEnabled(false);
        jButton9.setEnabled(false);
        jButton5.setEnabled(false);
        jButton6.setEnabled(false);
        
     
                }    
                }catch(Exception e)
        {
            CPrincipal.getConexion().cancelarTransaccion();
            e.printStackTrace();            
        }
    }//GEN-LAST:event_jButton8ActionPerformed

    private void jButton9ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton9ActionPerformed
        // TODO add your handling code here:
        try{
                
        boolean validar = false;     
       List<Ventas> nuevaVenta = hventas.consultaVentas("id", "=", String.valueOf(venta.getId()));
       
       if(Double.compare(nuevaVenta.get(0).getTotal(), comprobarCancelacion) != 0)
       {
        validar = true;   
       }
       
       
              
       if(validar)
       {
           JOptionPane.showMessageDialog(null, "Los datos han sido modificados en otra ventana, \n por favor cierrela, busque nuevamente la partida \n "
                   + "y realice la devolución");
           return;
       }
            
            
                ConexionWeb conexionweb = new ConexionWeb();
                String transaccion="";
            
                VConfirmaAlmacenista confirmaalmacenista = new VConfirmaAlmacenista((JFrame)Window.getWindows()[0],true);
                confirmaalmacenista.setLocationRelativeTo(null);
                confirmaalmacenista.setVisible(true);
                
                if(confirmaalmacenista.isExito())
                {
                
                if(!CPrincipal.getConexion().crearTransaccion())
                return;
                
                if(CGlobalConfig.isWeb())
                transaccion = conexionweb.iniciarTransaccion() + " ";
                            
                ventadevuelta.setArticulos(venta.getArticulos()); 
                ventadevuelta.setEstado(venta.getEstado());
                ventadevuelta.setIdcliente(venta.getIdcliente());
                ventadevuelta.setIdusuario(confirmaalmacenista.getIdalmacenista());
                ventadevuelta.setIdadministrador(confirmaalmacenista.getIdadministrador());
                ventadevuelta.setObservaciones(venta.getObservaciones());
                ventadevuelta.setPartidas(venta.getPartidas());
                ventadevuelta.setSubtotal(venta.getSubtotal());
                ventadevuelta.setTipoDeVenta(venta.getTipoDeVenta());
                ventadevuelta.setTotal(venta.getTotal());
                ventadevuelta.setIdVenta(venta.getId());
                ventadevuelta.setCodigoVenta("v"+venta.getId());
                ventadevuelta.setObservaciones(jTextField2.getText());
                
                 int devolucionGuardada=0;
                if(!CGlobalConfig.isWeb())
                devolucionGuardada=hdevoluciones.guardarVentas(ventadevuelta);
                 else            
                  {
                transaccion = transaccion + hdevoluciones.crearQueryGuardarVentas(ventadevuelta) + " ";
                transaccion = transaccion + conexionweb.ultimoId() + " ";
                  }
 
                int i=0;
                while(i<listaPartidasVentas.size())
                {
                    Kardex renglon=hkardex.consultaUltimoRenglon("articulo", "=", listaPartidasVentas.get(i).getCodigoArticulo());
                    
                    listaPartidasVentas.get(i).setIdVenta((long)devolucionGuardada);     
                    Partidasdevoluciones partidaDevolucion = new Partidasdevoluciones();
                    partidaDevolucion.setBeneficio(listaPartidasVentas.get(i).getBeneficio()); 
                    partidaDevolucion.setCantidad(listaPartidasVentas.get(i).getCantidad());
                    partidaDevolucion.setCodigoArticulo(listaPartidasVentas.get(i).getCodigoArticulo());
                    partidaDevolucion.setDescripcionArticulo(listaPartidasVentas.get(i).getDescripcionArticulo());
                    partidaDevolucion.setIdArticulo(listaPartidasVentas.get(i).getIdArticulo());
                    partidaDevolucion.setIdCompleto(listaPartidasVentas.get(i).getIdCompleto());
                    partidaDevolucion.setIdVenta(listaPartidasVentas.get(i).getIdVenta());
                    partidaDevolucion.setPrecioCompra(listaPartidasVentas.get(i).getPrecioCompra());
                    partidaDevolucion.setPrecioVenta(listaPartidasVentas.get(i).getPrecioVenta());
                    partidaDevolucion.setSubtotal(listaPartidasVentas.get(i).getSubtotal());
                    partidaDevolucion.setTipoBeneficio(listaPartidasVentas.get(i).getTipoBeneficio());
                    partidaDevolucion.setUbicacion(listaPartidasVentas.get(i).getUbicacion());
                    partidaDevolucion.setConBeneficio(listaPartidasVentas.get(i).getConBeneficio());
                    
                    
                    if(!CGlobalConfig.isWeb())
                    hpartidasdevoluciones.guardarPartidas(partidaDevolucion);
                    else
                    transaccion = transaccion + hpartidasdevoluciones.crearQueryGuardarPartidas(partidaDevolucion) + " ";    
                    
                //    Almacendevoluciones almacendevoluciones = new Almacendevoluciones();
                    almacendevoluciones.setBeneficio(listaPartidasVentas.get(i).getBeneficio());
                    almacendevoluciones.setCantidad(listaPartidasVentas.get(i).getCantidad());
                    almacendevoluciones.setCodigoArticulo(listaPartidasVentas.get(i).getCodigoArticulo());
                    almacendevoluciones.setConBeneficio(listaPartidasVentas.get(i).getConBeneficio());
                    almacendevoluciones.setDescripcionArticulo(listaPartidasVentas.get(i).getDescripcionArticulo());
                    almacendevoluciones.setExistenciaAlmacen(listaPartidasVentas.get(i).getCantidad());
                    almacendevoluciones.setIdArticulo(listaPartidasVentas.get(i).getIdArticulo());
                    almacendevoluciones.setIdVenta(listaPartidasVentas.get(i).getIdVenta());
                    almacendevoluciones.setIdCompleto(listaPartidasVentas.get(i).getIdCompleto());
                    almacendevoluciones.setPrecioCompra(listaPartidasVentas.get(i).getPrecioCompra());
                    almacendevoluciones.setPrecioVenta(listaPartidasVentas.get(i).getPrecioVenta());
                    almacendevoluciones.setSubtotal(listaPartidasVentas.get(i).getSubtotal());
                    almacendevoluciones.setTipoBeneficio(listaPartidasVentas.get(i).getTipoBeneficio());
                    
              List<Articulos> carticulo = harticulos.consultaArticulos("id", "=", String.valueOf(listaPartidasVentas.get(i).getIdArticulo()));
             if(!carticulo.isEmpty()
                &&Double.compare(carticulo.get(0).getPrecioCompra(), almacendevoluciones.getPrecioCompra())==0
                //   &&Double.compare(carticulo.get(0).getPrecioVenta(), almacendevoluciones.getPrecioVenta())==0     
                     )
              {                                                                          //el articulo se va a almacen principal, sino se va a devoluciones
                int nuevaExistencia = (int)carticulo.get(0).getExistencia() + almacendevoluciones.getCantidad(); //estas reglas se pueden aplicar para solo aceptar precios
                
                if(!CGlobalConfig.isWeb())
                harticulos.actualizarExistencias(carticulo.get(0).getCodigo(), nuevaExistencia); //mayores o menores y mandarlos a devoluciones...
                else
                transaccion = transaccion + harticulos.crearQueryActualizarExistencias(carticulo.get(0).getCodigo(), nuevaExistencia) + " ";    
                
                                if(renglon == null)
                {
                    //Se registra la pieza en Kardex
                    renglon = new Kardex();
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(carticulo.get(0).getAnticipos());
                    renglon.setArticulo(carticulo.get(0).getCodigo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)carticulo.get(0).getExistencia());
                    renglon.setIdArticulo(carticulo.get(0).getId());
                    renglon.setModificacion("Registro");
                    renglon.setMovimiento("Registro de Artículo");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(carticulo.get(0).getPrecioVenta());
                    renglon.setRefFerrari("Registro");
                    renglon.setReservados((int)carticulo.get(0).getReservado());
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(carticulo.get(0).getUltimoCosto());
                    renglon.setVendidoEn(0.0); 
                    
                if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(renglon); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";     
                    //19
                }
                
               }
             else
               {
               List<Almacendevoluciones> listaActualizar = halmacendevoluciones.consultaPartidas("codigoArticulo", "=", almacendevoluciones.getCodigoArticulo());
                   
               int indiceConocer = 0; 
               boolean bandera=true;
               while(indiceConocer<listaActualizar.size())
               {
             //      System.out.println("almacen " +almacendevoluciones.getCodigoArticulo() + "listaActualizar "+ listaActualizar.get(indiceConocer).getCodigoArticulo());
             //      System.out.println("almacen " +almacendevoluciones.getPrecioCompra() + "listaActualizar "+ listaActualizar.get(indiceConocer).getPrecioCompra());
             //      System.out.println("almacen " +almacendevoluciones.getPrecioVenta() + "listaActualizar "+ listaActualizar.get(indiceConocer).getPrecioVenta());
                   if(almacendevoluciones.getCodigoArticulo().equals(listaActualizar.get(indiceConocer).getCodigoArticulo())&&
                           Double.compare(almacendevoluciones.getPrecioCompra(),listaActualizar.get(indiceConocer).getPrecioCompra()) == 0&&
                           Double.compare(almacendevoluciones.getPrecioVenta(),listaActualizar.get(indiceConocer).getPrecioVenta()) == 0)
                   {
                   //    System.out.println("aaaaaa "+listaActualizar.get(indiceConocer).getId());
                       int nuevaCantidad = listaActualizar.get(indiceConocer).getCantidad() + almacendevoluciones.getCantidad();
                       if(!CGlobalConfig.isWeb())
                       {
                       halmacendevoluciones.actualizarExistencias(listaActualizar.get(indiceConocer).getId(), nuevaCantidad); 
                       harticulos.aumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), almacendevoluciones.getCantidad());
                       }else
                       {
                       transaccion = transaccion + halmacendevoluciones.crearQueryActualizarExistencias(listaActualizar.get(indiceConocer).getId(), nuevaCantidad) + " ";     
                       List<Articulos> artlos = harticulos.consultaArticulos("codigo", "=", almacendevoluciones.getCodigoArticulo());
                       int catalogo = artlos.get(0).getAlmacenDevoluciones();
                       int totalcantidad = catalogo + almacendevoluciones.getCantidad();
                       transaccion = transaccion + harticulos.crearQueryAumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), totalcantidad) + " ";     
                       }    
                       indiceConocer = listaActualizar.size();
                       bandera = false;
                       
                 if(renglon == null)
                {
                    //Se registra la pieza en Kardex
                    renglon = new Kardex();
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(0);
                    renglon.setArticulo(almacendevoluciones.getCodigoArticulo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)nuevaCantidad);
                    renglon.setIdArticulo(almacendevoluciones.getIdArticulo());
                    renglon.setModificacion("Registro Almacén Devoluciones");
                    renglon.setMovimiento("Registro de Artículo AD");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(almacendevoluciones.getPrecioVenta());
                    renglon.setRefFerrari("AD Registro");
                    renglon.setReservados(0);
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático AD");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(almacendevoluciones.getPrecioCompra());
                    renglon.setVendidoEn(0.0); 
                    
                   if(!CGlobalConfig.isWeb())
                   hkardex.guardarEnKardex(renglon); 
                   else
                   transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";     
                    //19
                } 
                       
                   }
 
                   indiceConocer++;
               }
                   
               if(bandera)
               {
              
             if(!CGlobalConfig.isWeb())
               {
               halmacendevoluciones.guardarPartidas(almacendevoluciones);   
               harticulos.aumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), almacendevoluciones.getCantidad());
               }
              else
              {
             transaccion = transaccion + halmacendevoluciones.crearQueryGuardarPartidas(almacendevoluciones) + " ";     
             List<Articulos> artlos = harticulos.consultaArticulos("codigo", "=", almacendevoluciones.getCodigoArticulo());
             int catalogo = artlos.get(0).getAlmacenDevoluciones();
             int totalcantidad = catalogo + almacendevoluciones.getCantidad();
             transaccion = transaccion + harticulos.crearQueryAumentaAlmacenDevoluciones(almacendevoluciones.getCodigoArticulo(), totalcantidad) + " ";     
               }    
               
                   if(renglon == null)
                {  
                    renglon = new Kardex();
                    renglon.setAlmacenista("");
                    renglon.setAnticipos(0);
                    renglon.setArticulo(almacendevoluciones.getCodigoArticulo());
                    renglon.setEntrada(0);
                    renglon.setExistencias((int)almacendevoluciones.getCantidad());
                    renglon.setIdArticulo(almacendevoluciones.getIdArticulo());
                    renglon.setModificacion("Registro Almacén Devoluciones");
                    renglon.setMovimiento("Registro de Artículo AD");
                    renglon.setNoMov("1");
                    renglon.setPrecioVenta(almacendevoluciones.getPrecioVenta());
                    renglon.setRefFerrari("AD Registro");
                    renglon.setReservados(0);
                    renglon.setResponsable("1");
                    renglon.setResponsable2("Registro Automático AD");
                    renglon.setSalida(0);
                    renglon.setUltimoCosto(almacendevoluciones.getPrecioCompra());
                    renglon.setVendidoEn(0.0); 
                    
                if(!CGlobalConfig.isWeb())
                hkardex.guardarEnKardex(renglon); 
                else
                transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(renglon) + " ";   
                            }
               
               }
               }
           //    if(!carticulo.isEmpty()&&carticulo.get(0).getPrecioCompra()==almacendevoluciones.getPrecioCompra() &&
           //       carticulo.get(0).getPrecioVenta()==almacendevoluciones.getPrecioVenta()) //si el precio de lo que se va a devolver son iguales a los que hay en el almacen principal
                    // halmacendevoluciones.guardarPartidas(partidaDevolucion);    
            
            Kardex kardex = new Kardex(); 
            kardex.setAlmacenista("");
            kardex.setArticulo(listaPartidasVentas.get(i).getCodigoArticulo());
            kardex.setEntrada((int)listaPartidasVentas.get(i).getCantidad());
            kardex.setIdArticulo(listaPartidasVentas.get(i).getIdArticulo()); 
            kardex.setExistencias(renglon.getExistencias()+(int)listaPartidasVentas.get(i).getCantidad());
            kardex.setModificacion("Cancelación Artículo");
            kardex.setMovimiento("Cancelación Artículo");
            String nomov = String.valueOf(Integer.parseInt(renglon.getNoMov()) + 1);
            kardex.setNoMov(nomov); 
            kardex.setPrecioVenta(listaPartidasVentas.get(i).getPrecioVenta());
            kardex.setRefFerrari("V"+String.valueOf(this.venta.getId())); 
            kardex.setReservados(renglon.getReservados()); 
            kardex.setAnticipos(renglon.getAnticipos());
            kardex.setResponsable(String.valueOf(CConfiguracion.getId())); //para saber quién hizo la devolución
            kardex.setSalida(0); //no hay artículos en salida pues es una devolución
            kardex.setUltimoCosto(listaPartidasVentas.get(i).getPrecioCompra());
            kardex.setVendidoEn(listaPartidasVentas.get(i).getConBeneficio());
            kardex.setResponsable2(confirmaalmacenista.getNombreAdministrador());
            
            if(!CGlobalConfig.isWeb())
            hkardex.guardarEnKardex(kardex); 
            else
            transaccion = transaccion + hkardex.crearQueryGuardarEnKardexCompleto(kardex) + " ";   
             
             i++;       
                }
                
                for(int rows=dtm.getRowCount()-1; rows >= 0; rows--)
                {
                    dtm.removeRow(rows);
                }
                
                
                


                venta.setArticulos(0);
                venta.setEstado("Devuelta");
                venta.setPartidas(0);
                venta.setSubtotal((double)0);
                venta.setTotal((double)0);
                
                if(!CGlobalConfig.isWeb())
                {
                hventas.actualizarVentasDev(venta, "id", "=", String.valueOf(venta.getId()));
                hpartidas.borrarPartidas("idVenta","=", String.valueOf(venta.getId()));
                }else
                {
                transaccion = transaccion + hventas.crearQueryActualizarVentasDev(venta, "id", "=", String.valueOf(venta.getId())) + " "; 
                transaccion = transaccion + hpartidas.crearQueryBorrarPartidas("idVenta","=", String.valueOf(venta.getId())) + " "; 
                }
                
                      jLabel2.setText(String.valueOf(venta.getId()));
                      jLabel4.setText(String.valueOf(venta.getArticulos()));
                      jLabel6.setText(String.valueOf(venta.getPartidas()));
                      jLabel8.setText(String.valueOf(venta.getSubtotal()));
                      jLabel10.setText(String.valueOf(venta.getTotal()));
                      jLabel12.setText(venta.getTipoDeVenta());
                      jLabel14.setText(venta.getFechaVenta());
                      jLabel16.setText(venta.getObservaciones());
                      jLabel34.setText(venta.getEstado());
                      
                
                 jTable1.setModel(dtm);     
          
        hCuentasPorCobrar hcc = new hCuentasPorCobrar();
        
        if(jLabel12.getText().equalsIgnoreCase("Credito"))
        {
        if(!CGlobalConfig.isWeb())
        hcc.borrarCtaPorCobrar("venta", "=", jLabel2.getText());
        else
        transaccion = transaccion + hcc.crearQueryBorrarCtaPorCobrar("venta", "=", jLabel2.getText()) + " ";     
        }
         
        CPrincipal.getConexion().finalizarTransaccion();
        
        if(CGlobalConfig.isWeb())
               {
               transaccion = transaccion + conexionweb.finalizarTransaccion();    
               conexionweb.escribirEnWeb(transaccion);
               }
        
           try {
        ImpresionDevolucionCaja idc = new ImpresionDevolucionCaja();
        idc.inicializar(String.valueOf(venta.getId()), jLabel30.getText(), jLabel4.getText(), 
                                       confirmaalmacenista.getNombreAdministrador(), hcc.generarFecha().substring(0, 20), listaPartidasVentas, 
                                       jLabel12.getText(), jLabel8.getText(), jLabel10.getText(), 
                                       String.valueOf(0), jTextField2.getText(),"CANCELACIÓN");
         PrinterJob job = PrinterJob.getPrinterJob();
        // PageFormat format = job.pageDialog(job.defaultPage());
         
        PageFormat format = new PageFormat();
        
        
        Paper p = new Paper();
        
        p.setSize(CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        p.setImageableArea(CGlobalConfig.getxImp(),CGlobalConfig.getyImp(),CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        format.setPaper(p); 
         
        job.setPageable(new PageableText(idc.generarCadenaImpresion(), format));
         // job.setPrintable(idc);
         if (job.printDialog())
         job.print();
         }  catch (IOException ex) {
                Logger.getLogger(VDetalle_Ventas.class.getName()).log(Level.SEVERE, null, ex);
            } catch (PrinterException ex) {
            Logger.getLogger(ImpresionVenta.class.getName()).log(Level.SEVERE, null, ex);
        }
        
        try {
        ImpresionCancelacionAlmacen ica = new ImpresionCancelacionAlmacen();
        ica.inicializar(String.valueOf(venta.getId()), jLabel30.getText(), jLabel4.getText(), 
                                       confirmaalmacenista.getNombreAdministrador(), hcc.generarFecha().substring(0, 20), listaPartidasVentas, 
                                       jLabel12.getText(), jTextField2.getText(), confirmaalmacenista.getAlmacenista(),"CANCELACIÓN");
         PrinterJob job = PrinterJob.getPrinterJob();
        // PageFormat format = job.pageDialog(job.defaultPage());
         
        PageFormat format = new PageFormat();
        
        
        Paper p = new Paper();
        
        p.setSize(CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        p.setImageableArea(CGlobalConfig.getxImp(),CGlobalConfig.getyImp(),CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        format.setPaper(p);  
         
        job.setPageable(new PageableText(ica.generarCadenaImpresion(), format));
         //job.setPrintable(ica);
         if (job.printDialog())
         job.print();
         }  catch (IOException ex) {
                Logger.getLogger(VDetalle_Ventas.class.getName()).log(Level.SEVERE, null, ex);
            } catch (PrinterException ex) {
            Logger.getLogger(ImpresionVenta.class.getName()).log(Level.SEVERE, null, ex);
        }          
                 
                      
        JOptionPane.showMessageDialog(null, "Cancelación Completa Efectuada");
        
        jButton8.setEnabled(false);
        jButton9.setEnabled(false);
        jButton5.setEnabled(false);
        jButton6.setEnabled(false);
     
                }    
      }catch(Exception e)
        {
            CPrincipal.getConexion().cancelarTransaccion();
            e.printStackTrace();            
        }
    }//GEN-LAST:event_jButton9ActionPerformed

    private void jButton4ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton4ActionPerformed
        // TODO add your handling code here:
      //  Book book = new Book();
        Object elecciones[] = new Object[] {"Ticket","Carta"}; 
 
        
        int decision = JOptionPane.showOptionDialog(null, "Por favor mencione el formato en que se imprima su venta", "Venta", 
                JOptionPane.DEFAULT_OPTION, JOptionPane.QUESTION_MESSAGE, null,elecciones, "Ticket");
        
        switch(decision){
            case -1:
                break;
            case 0:
                try
        {        
        ImpresionTicketVenta itv = new ImpresionTicketVenta();
        itv.inicializar(String.valueOf(venta.getId()),jLabel30.getText(),
                                               jLabel4.getText(),jLabel21.getText(), jLabel14.getText(), listaPartidas,
                                               String.valueOf(venta.getTipoDeVenta()), String.valueOf(venta.getSubtotal()),
                                               String.valueOf(venta.getTotal()),String.valueOf(venta.getIva()));
        PrinterJob job = PrinterJob.getPrinterJob();
       // PageFormat pf = job.pageDialog(job.defaultPage());
       // PageFormat format = job.pageDialog(job.defaultPage());
        
        PageFormat format = new PageFormat();
        
        
        Paper p = new Paper();
        
        p.setSize(CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        p.setImageableArea(CGlobalConfig.getxImp(),CGlobalConfig.getyImp(),CGlobalConfig.getAnchoImp(),CGlobalConfig.getAltoImp());
        format.setPaper(p);
        
        job.setPageable(new PageableText(itv.generarCadenaImpresion(), format));
       // job.setPrintable(itv);
     //   book.append(itv, pf);
     //   job.setPageable(book);
        if (job.printDialog())
            job.print();
        
        reimpresion.setFecha(jLabel14.getText());
        reimpresion.setFolio(jLabel2.getText());
        reimpresion.setImporte(jLabel10.getText());
        reimpresion.setUsuario(CConfiguracion.getFoto());
        reimpresion.setVendedor(jLabel20.getText());
        hreimpresion.guardarReimpresiones(reimpresion);
        
        } catch (IOException ex) {
            Logger.getLogger(VDetalle_Ventas.class.getName()).log(Level.SEVERE, null, ex);
        }catch (PrinterException ex) {
            Logger.getLogger(ImpresionVenta.class.getName()).log(Level.SEVERE, null, ex);
        }
            JOptionPane.showMessageDialog(null, "Reimpresión concluida");
        break;
            case 1:
                ReporteVentaHojaCarta rvhc = new ReporteVentaHojaCarta();
                rvhc.crearReporte(jLabel2.getText());
                JOptionPane.showMessageDialog(null, "Reimpresión concluida");
                break;
        }
        
    }//GEN-LAST:event_jButton4ActionPerformed

    private void jButton10ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton10ActionPerformed
        // TODO add your handling code here:
                // TODO add your handling code here:
         if( jCheckBox1.isSelected())
         {
             JOptionPane.showMessageDialog(null, "Esta venta ya ha sido facturada, por favor consulta el catálogo de facturas");
             return;
         } 
        
        double iva = 0.0;
        double subtotal = 0.0;
        double total = 0.0;
        
        //caso público en general

        if(cliente.getNombre().equals("Público en general"))
        {
            iva = 0;
            subtotal = venta.getTotal();
            total = venta.getTotal();
        }
        //caso cliente con RFC
        else
        {
            subtotal = venta.getTotal() / 1.16;
            iva = venta.getTotal() - subtotal;
            total = subtotal + iva;    
        }    
        
        Numero_a_Letra numeroaletra = new Numero_a_Letra();
        Factura ventafactura = new Factura();
        
        hFacturasCFDI hfacturas = new hFacturasCFDI();
        Factura revision = hfacturas.consultaUltimaFactura("idConceptoFactura", "=", "VC"+venta.getId());
        if(revision != null && revision.getFolio() != null)
        {
            int eleccion = JOptionPane.showConfirmDialog(null, "Esta venta ya ha sido facturada, por favor revise VC"+venta.getId()+" en el catálogo de facturas \n"
                                                + "¿Desea proseguir?");
            if(eleccion != JOptionPane.YES_OPTION)
            return;
        }
        
        ventafactura.setFormaDePago(venta.getTipoDeVenta().toLowerCase());
        ventafactura.setSubtotal(String.valueOf(df.format(subtotal)));
        ventafactura.setImpuesto(String.valueOf(df.format(iva)));
        ventafactura.setTotal(String.valueOf(df.format(total)));
        ventafactura.setIdConceptoFactura("VC"+venta.getId());
        ventafactura.setTotalLetra(numeroaletra.Convertir(df.format(total), true));
        ventafactura.setIdReceptorF(venta.getIdcliente().intValue());
        // ventafactura.setMotivo(jTextField2.getText());
        ventafactura.setMotivo("Venta "+venta.getId());
        // ventafactura.setMotivo(String.valueOf(venta.getId()));
        ventafactura.setMovimiento(venta.getTipoDeVenta());
        
        
        VDetalle_FacturaCFDI factura = new VDetalle_FacturaCFDI(ventafactura,"venta");
        int indice = ((JTabbedPane) getParent().getParent().getParent()).getSelectedIndex();
        indice += 1;
        ((JTabbedPane) getParent().getParent().getParent()).add(new JScrollPane(factura), indice);
        ((JTabbedPane) getParent().getParent().getParent()).setTabComponentAt(indice, new botonCierre("Factura", indice));
        ((JTabbedPane) getParent().getParent().getParent()).setSelectedIndex(indice);
    }//GEN-LAST:event_jButton10ActionPerformed

    private void jButton3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton3ActionPerformed
        // TODO add your handling code here:
        Conexion conexion = new Conexion();
        
        String guardarConexion = CGlobalConfig.getConexion();
        boolean guardarWeb = CGlobalConfig.isWeb();
        int indice = 0;
        
        SeleccionaSucursal seleccionar = new SeleccionaSucursal((JFrame)Window.getWindows()[0],true);
        seleccionar.setLocationRelativeTo((JFrame)Window.getWindows()[0]);
        seleccionar.setVisible(true);
        if(seleccionar.isSeleccionar())
        {          
            
        hArticulos harticulos = new hArticulos();
        hPartidasComprasMayoreo hpartidascomprasmayoreo = new hPartidasComprasMayoreo();
        List<Articulos> articulos = new ArrayList<Articulos>();  
        hComprasMayoreo hcompras = new hComprasMayoreo();
            
        for(int i = 0; i < listaPartidas.size(); i++)
        {
        articulos =  harticulos.consultaArticulos("codigo", "=", listaPartidas.get(i).getCodigoArticulo());
        
        if(articulos.isEmpty())
        {
            JOptionPane.showMessageDialog(null, "El código "+listaPartidas.get(i).getCodigoArticulo() + "no existe en este catálogo de artículos");
            return;
        }
        listaPartidas.get(i).setPrecioVenta(articulos.get(0).getPrecioVenta());
        }    
        
        indice = seleccionar.getIndice();
        // cambio de conexión   
        
        
        
        if(Boolean.valueOf(CGlobalConfig.getEsWeb()[seleccionar.getIndice()]))
        {
        CGlobalConfig.setWeb(true);        
        CGlobalConfig.setConexion(CGlobalConfig.getDireccionSucursal()[seleccionar.getIndice()]);    
        }else
        {    
        CPrincipal.getConexion().cerrarConexion();
        CGlobalConfig.setWeb(false);        
        CGlobalConfig.setConexion(CGlobalConfig.getDireccionSucursal()[seleccionar.getIndice()]);    
        conexion.setURL_BASEDATOS(CGlobalConfig.getDireccionSucursal()[seleccionar.getIndice()] +"?zeroDateTimeBehavior=convertToNull");
        conexion.crearConexion();
        CPrincipal.setConexion(conexion);
        }
        
        
        
        //cambio de conexión
        
        VDialog_Autenticar autenticar = new VDialog_Autenticar((JFrame)Window.getWindows()[0],true);
        autenticar.setLocationRelativeTo((JFrame)Window.getWindows()[0]);
        autenticar.setVisible(true);
        
        if(!autenticar.isAutenticar())
        {
          //Regresar a la conexión anterior  
        
        if(guardarWeb)
        {
        CGlobalConfig.setWeb(guardarWeb);        
        CGlobalConfig.setConexion(guardarConexion);    
        }else
        {     
        CPrincipal.getConexion().cerrarConexion();
        CGlobalConfig.setWeb(guardarWeb);
        CGlobalConfig.setConexion(guardarConexion);
        conexion.setURL_BASEDATOS(guardarConexion +"?zeroDateTimeBehavior=convertToNull");
        conexion.crearConexion();
        CPrincipal.setConexion(conexion);            
        }
            
          //Regresar a la conexión anterior
            return;
        }
        
        //Validar que no exista la compra
        
        List<ComprasMayoreo> validaCompra = hcompras.consultaCompras("factura", "=",String.valueOf(venta.getId()));
        
        if(!validaCompra.isEmpty())
        {
            
           //Regresar a la conexión anterior     
        if(guardarWeb)
        {
        CGlobalConfig.setWeb(guardarWeb);        
        CGlobalConfig.setConexion(guardarConexion);    
        }else
        {     
        CPrincipal.getConexion().cerrarConexion();
        CGlobalConfig.setWeb(guardarWeb);
        CGlobalConfig.setConexion(guardarConexion);
        conexion.setURL_BASEDATOS(guardarConexion +"?zeroDateTimeBehavior=convertToNull");
        conexion.crearConexion();
        CPrincipal.setConexion(conexion);            
        }         
            
          //Regresar a la conexión anterior
        JOptionPane.showMessageDialog(null, "Esta compra ya se encuentra capturada con la factura "+venta.getId() + " en la sucursal de "+ CGlobalConfig.getNombreSucursal()[seleccionar.getIndice()]);    
        
            return;
        }
        
        
        Dialog_SeleccionarProveedor seleccionarP = new Dialog_SeleccionarProveedor((JFrame)Window.getWindows()[0],true);
        seleccionarP.setLocationRelativeTo((JFrame)Window.getWindows()[0]);
        seleccionarP.setVisible(true);
        
        if(!seleccionarP.isSeleccionar())
        {
          //Regresar a la conexión anterior     
        if(guardarWeb)
        {
        CGlobalConfig.setWeb(guardarWeb);        
        CGlobalConfig.setConexion(guardarConexion);    
        }else
        {     
        CPrincipal.getConexion().cerrarConexion();
        CGlobalConfig.setWeb(guardarWeb);
        CGlobalConfig.setConexion(guardarConexion);
        conexion.setURL_BASEDATOS(guardarConexion +"?zeroDateTimeBehavior=convertToNull");
        conexion.crearConexion();
        CPrincipal.setConexion(conexion);            
        }         
            
          //Regresar a la conexión anterior
            return;
        }
        
        
        List<Partidascomprasmayoreo> partidascomprasmayoreo = new ArrayList<Partidascomprasmayoreo>();
        double sinIVA=0.0;
        double iva = 0.0;
        double montoSubtotal = 0.0;
        

        for(int i = 0; i<listaPartidas.size(); i++)
        {
            
            Partidascomprasmayoreo partida = new Partidascomprasmayoreo();
            
            articulos = harticulos.consultaArticulos("codigo", "=", listaPartidas.get(i).getCodigoArticulo());
            if(articulos.isEmpty())
            {
                JOptionPane.showMessageDialog(null, "El código "+ listaPartidas.get(i).getCodigoArticulo() + " no aparece en el catálogo de artículos " +
                         "de la sucursal "+CGlobalConfig.getNombreSucursal()[seleccionar.getIndice()] + ", por favor capture este artículo en la sucursal "
                        + "antes de realizar la transferencia");
                
         //Regresar a la conexión anterior     
        if(guardarWeb)
        {
        CGlobalConfig.setWeb(guardarWeb);        
        CGlobalConfig.setConexion(guardarConexion);    
        }else
        {     
        CPrincipal.getConexion().cerrarConexion();
        CGlobalConfig.setWeb(guardarWeb);
        CGlobalConfig.setConexion(guardarConexion);
        conexion.setURL_BASEDATOS(guardarConexion +"?zeroDateTimeBehavior=convertToNull");
        conexion.crearConexion();
        CPrincipal.setConexion(conexion);            
        }          
            
         //Regresar a la conexión anterior
                
                return;
            }else
            {
            if(!articulos.get(0).getDescripcion().equals(listaPartidas.get(i).getDescripcionArticulo()))    
            {
                //descripción no coincide
             int eleccion = JOptionPane.showConfirmDialog(null, "La descripción del código "+listaPartidas.get(i).getCodigoArticulo() 
                        + " no coincide con la descripción del catálogo de artículos en "+CGlobalConfig.getNombreSucursal()[seleccionar.getIndice()]
                        + " \n ¿Deseas actualizar la descripción de este artículo en el catálogo de la sucursal?", "Confirmación", JOptionPane.YES_NO_OPTION, JOptionPane.QUESTION_MESSAGE);
                
             if(eleccion==JOptionPane.YES_OPTION)   
             {
             //Actualizar
             articulos.get(0).setDescripcion(listaPartidas.get(i).getDescripcionArticulo());
             harticulos.actualizarArticulos(articulos.get(0),"codigo", "=", listaPartidas.get(i).getCodigoArticulo());
             
             }   
            }
            
            
             sinIVA = listaPartidas.get(i).getConBeneficio() / (1 + (((double)articulos.get(0).getIva() / 100.0)));
             iva = listaPartidas.get(i).getSubtotal() * ((double)articulos.get(0).getIva() / 100.0);
             montoSubtotal = sinIVA * listaPartidas.get(i).getCantidad();
             
              partida.setArticulo(listaPartidas.get(i).getCodigoArticulo());
              partida.setCadenaCascada("SIN CASCADA");
              partida.setCantidad(listaPartidas.get(i).getCantidad());
              partida.setCargoArticulo(0.0);
              partida.setCascada(0);
              partida.setCompra((long)0); 
              partida.setCostoDesc(sinIVA); 
              partida.setDescripcion(articulos.get(0).getDescripcion());
              partida.setDescuento(0.0);
              partida.setDescuentoArti(0.0);
              partida.setDevuelta(0);
              partida.setIva(articulos.get(0).getIva());
              partida.setMontoIva(iva);
              partida.setMotivoDevolucion("Sin Motivo");
              partida.setPorcCargo(0);
              partida.setPrecioCompra(sinIVA); 
              partida.setPrecioUni(sinIVA); 
              partida.setPrecioVenta(listaPartidas.get(i).getPrecioVenta());
              partida.setReferencia("00000");
              partida.setStockMax((int)articulos.get(0).getMaximoPzas());
              partida.setStockMin((int)articulos.get(0).getMinimoPzas());
              partida.setSubtotal(montoSubtotal);
              partida.setTotal(listaPartidas.get(i).getSubtotal());
              partida.setUtilidad(0.0); 
            
            
            }
            
            partidascomprasmayoreo.add(partida);
        }
        
         ComprasMayoreo comprafinal = new ComprasMayoreo();    

        comprafinal.setTipoPago("Crédito");    
        comprafinal.setCheque(" ");
        comprafinal.setBanco(" ");           
        comprafinal.setCargos(0.0);    
        comprafinal.setCodigoPedido((long)0);
        comprafinal.setCodigoProveedor(seleccionarP.getId());
        comprafinal.setCompra(0);
        comprafinal.setDescAdic(String.valueOf(0.0));
        comprafinal.setDevolucion(0);
        comprafinal.setDiasCred(seleccionarP.getDiasCredito());
        comprafinal.setImporte(venta.getTotal());
        comprafinal.setNumRefComp("");
        comprafinal.setPedido(0);
        comprafinal.setObservacion("CA"+ String.valueOf(venta.getId()));
        comprafinal.setFactura(String.valueOf(venta.getId()));
        comprafinal.setIdUsuario(String.valueOf(autenticar.getId()));
        comprafinal.setTn("SIN TN");
        
        int cantidadArticulo = 0;
        for(int i=0; i<partidascomprasmayoreo.size();i++)
        {
            cantidadArticulo = cantidadArticulo + partidascomprasmayoreo.get(i).getCantidad();
        }
        
        
        comprafinal.setCantidadArticulos(String.valueOf(cantidadArticulo));
        
        ConexionWeb conexionweb = new ConexionWeb();
        String transaccion="";
        
        if(!CPrincipal.getConexion().crearTransaccion())
        return;
        
        if(CGlobalConfig.isWeb())
        transaccion = conexionweb.iniciarTransaccion();
        
         int numcompra = 0;
         if(!CGlobalConfig.isWeb())
         numcompra = hcompras.guardarComprasLast(comprafinal);        
            else            
            {
            transaccion = transaccion + hcompras.crearQueryGuardar(comprafinal) + " ";
            transaccion = transaccion + conexionweb.ultimoId() + " ";
            }
        if(!CGlobalConfig.isWeb())
        {
        comprafinal.setNumRefComp(String.valueOf(numcompra));
        hcompras.actualizarComprasLast(comprafinal,"id","=",String.valueOf(numcompra));        
        } else            
            {
        transaccion = transaccion + hcompras.crearQueryComprasLast(comprafinal,"id","=",String.valueOf(numcompra)) + " ";
            }
        
        int indparti=0;
        while(indparti<partidascomprasmayoreo.size())
        {
        
        if(!CGlobalConfig.isWeb())
        {
            partidascomprasmayoreo.get(indparti).setCompra((long)numcompra);
            hpartidascomprasmayoreo.guardarPCompras(partidascomprasmayoreo.get(indparti));            
        }else
        {
        transaccion = transaccion + hpartidascomprasmayoreo.crearQueryPCompras(partidascomprasmayoreo.get(indparti)) + " ";   
        }
        
        
        
            indparti++;
        }
        
        
        
        CPrincipal.getConexion().finalizarTransaccion();
               
               if(CGlobalConfig.isWeb())
               {
               transaccion = transaccion + conexionweb.finalizarTransaccion();    
               conexionweb.escribirEnWeb(transaccion);
               numcompra = (int)hcompras.consultaComprasUltima();
               }
        
        JOptionPane.showMessageDialog(null,"Compra Guardada con Folio "+numcompra);

        
        
        //Cambiar Conexión
        if(guardarWeb)
        {
        CGlobalConfig.setWeb(guardarWeb);        
        CGlobalConfig.setConexion(guardarConexion);    
        }else
        {     
        CPrincipal.getConexion().cerrarConexion();
        CGlobalConfig.setWeb(guardarWeb);
        CGlobalConfig.setConexion(guardarConexion);
        conexion.setURL_BASEDATOS(guardarConexion +"?zeroDateTimeBehavior=convertToNull");
        conexion.crearConexion();
        CPrincipal.setConexion(conexion);            
        }            
        //Cambiar Conexión
       
        }
        
    }//GEN-LAST:event_jButton3ActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButton1;
    public static javax.swing.JButton jButton10;
    private javax.swing.JButton jButton2;
    private javax.swing.JButton jButton3;
    private javax.swing.JButton jButton4;
    private javax.swing.JButton jButton5;
    private javax.swing.JButton jButton6;
    private javax.swing.JButton jButton7;
    private javax.swing.JButton jButton8;
    private javax.swing.JButton jButton9;
    private javax.swing.JCheckBox jCheckBox1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel10;
    private javax.swing.JLabel jLabel11;
    private javax.swing.JLabel jLabel12;
    private javax.swing.JLabel jLabel13;
    private javax.swing.JLabel jLabel14;
    private javax.swing.JLabel jLabel15;
    private javax.swing.JLabel jLabel16;
    private javax.swing.JLabel jLabel17;
    private javax.swing.JLabel jLabel18;
    private javax.swing.JLabel jLabel19;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel20;
    private javax.swing.JLabel jLabel21;
    private javax.swing.JLabel jLabel22;
    private javax.swing.JLabel jLabel23;
    private javax.swing.JLabel jLabel24;
    private javax.swing.JLabel jLabel25;
    private javax.swing.JLabel jLabel26;
    private javax.swing.JLabel jLabel27;
    private javax.swing.JLabel jLabel28;
    private javax.swing.JLabel jLabel29;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel30;
    private javax.swing.JLabel jLabel31;
    private javax.swing.JLabel jLabel32;
    private javax.swing.JLabel jLabel33;
    private javax.swing.JLabel jLabel34;
    private javax.swing.JLabel jLabel35;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTable jTable1;
    private javax.swing.JTextField jTextField1;
    private javax.swing.JTextField jTextField2;
    // End of variables declaration//GEN-END:variables
    hPartidasDevoluciones hpartidasdevoluciones;
    hDevoluciones hdevoluciones;
    hUsuarios husuarios;
    hClientes hclientes;
    hPartidas hpartidas;
    hAlmacendevoluciones halmacendevoluciones;
    hVentas hventas;
    hArticulos harticulos;
    List<Usuarios> lusuario,ladministrador;
    List<Clientes> lcliente;
    Usuarios usuario,administrador;
    Clientes cliente;
    DefaultTableModel dtm;
    Vector vector;
    List<Partidas>  listaPartidas,listaPartidasVentas,listaBorrar;
    List<Partidasdevoluciones> listaDevoluciones;
    Vector<String> encabezadoPartidas;
    Ventas devolucion,venta,cancelar;
    Devoluciones ventadevuelta;
    Almacendevoluciones almacendevoluciones;
    hKardex hkardex;
    DecimalFormat df;
    Reimpresiones reimpresion;
    hReimpresiones hreimpresion;
    double comprobarCancelacion = 0.0;
    
    private void inicializar(Ventas venta) {
      df = new DecimalFormat("0.00");  
      reimpresion = new Reimpresiones();
      hreimpresion = new hReimpresiones();
        
      jLabel2.setText(String.valueOf(venta.getId()));
      jLabel4.setText(String.valueOf(venta.getArticulos()));
      jLabel6.setText(String.valueOf(venta.getPartidas()));
      jLabel8.setText(String.valueOf(df.format(venta.getSubtotal())));
      jLabel10.setText(String.valueOf(df.format(venta.getTotal())));
      jLabel12.setText(venta.getTipoDeVenta());
      jLabel14.setText(venta.getFechaVenta());
      jLabel16.setText(venta.getObservaciones());
      jLabel34.setText(venta.getEstado());
      
      if(venta.getEstadoFactura().equals("Facturada"))
          jCheckBox1.setSelected(true);
      else
          jCheckBox1.setSelected(false);
      
      jCheckBox1.setEnabled(false);
      jTextField2.setEditable(true);
      
      devolucion = new Ventas();
      this.venta = new Ventas();
      cancelar = new Ventas();
     // devolucion = venta;
     // this.venta = venta;
     
      // cancelar = venta;
      cancelar.setArticulos(venta.getArticulos());
      cancelar.setEstado(venta.getEstado());
      cancelar.setFechaVenta(venta.getFechaVenta());
      cancelar.setId(venta.getId());
      cancelar.setIdadministrador(venta.getIdadministrador());
      cancelar.setIdcliente(venta.getIdcliente());
      cancelar.setIdusuario(venta.getIdusuario());
      cancelar.setObservaciones(venta.getObservaciones());
      cancelar.setPartidas(venta.getPartidas());
      cancelar.setSubtotal(venta.getSubtotal());
      cancelar.setTipoDeVenta(venta.getTipoDeVenta());
      cancelar.setTotal(venta.getTotal());
      
      this.venta.setArticulos(venta.getArticulos());
      this.venta.setEstado(venta.getEstado());
      this.venta.setFechaVenta(venta.getFechaVenta());
      this.venta.setId(venta.getId());
      this.venta.setIdadministrador(venta.getIdadministrador());
      this.venta.setIdcliente(venta.getIdcliente());
      this.venta.setIdusuario(venta.getIdusuario());
      this.venta.setObservaciones(venta.getObservaciones());
      this.venta.setPartidas(venta.getPartidas());
      this.venta.setSubtotal(venta.getSubtotal());
      this.venta.setTipoDeVenta(venta.getTipoDeVenta());
      this.venta.setTotal(venta.getTotal());
      this.venta.setIva(venta.getIva());
      
      comprobarCancelacion = this.venta.getTotal();

      devolucion.setArticulos(venta.getArticulos());
      devolucion.setEstado(venta.getEstado());
      devolucion.setFechaVenta(venta.getFechaVenta());
      devolucion.setId(venta.getId());
      devolucion.setIdadministrador(venta.getIdadministrador());
      devolucion.setIdcliente(venta.getIdcliente());
      devolucion.setIdusuario(venta.getIdusuario());
      devolucion.setObservaciones(venta.getObservaciones());
      devolucion.setPartidas(venta.getPartidas());
      devolucion.setSubtotal(venta.getSubtotal());
      devolucion.setTipoDeVenta(venta.getTipoDeVenta());
      devolucion.setTotal(venta.getTotal());
      
      husuarios = new hUsuarios();
      lusuario = husuarios.consultaUsuarios("id", "=", String.valueOf(venta.getIdusuario()));
      usuario = new Usuarios();
       int i = 0;
       while(i<lusuario.size())
       {
           usuario = lusuario.get(i);
           i++;
       }
      
       jLabel20.setText(usuario.getFoto());
       jLabel21.setText(usuario.getNombres()+" "+usuario.getApellidoP()+" "+usuario.getApellidoM());
       jLabel22.setText(usuario.getPuesto());
       
       if(venta.getIdadministrador() == -1)
       {
       jLabel26.setText("");
       jLabel27.setText("Venta sin Administrador");
       jLabel28.setText("");
       }
       else
       {
     ladministrador = husuarios.consultaUsuarios("id", "=", String.valueOf(venta.getIdadministrador()));
      administrador = new Usuarios();
       i = 0;
       while(i<ladministrador.size())
       {
           administrador = ladministrador.get(i);
           i++;
       }
      

       
       jLabel26.setText(administrador.getFoto());
       jLabel27.setText(administrador.getNombres()+" "+administrador.getApellidoP()+" "+administrador.getApellidoM());
       jLabel28.setText(administrador.getPuesto());
       }
       
       
      hclientes = new hClientes();
      lcliente = hclientes.consultaClientes("id", "=", String.valueOf(venta.getIdcliente()));
      cliente = new Clientes();
       i = 0;
       while(i<lcliente.size())
       {
           cliente = lcliente.get(i);
           cliente.setNombre(lcliente.get(i).getNombre());
           cliente.setId(lcliente.get(i).getId());
           i++;
       }
      
      jLabel30.setText(cliente.getNombre());
      jLabel32.setText(cliente.getRfc());
      
      hpartidas = new hPartidas();
      listaPartidas = new ArrayList<Partidas>();
      listaBorrar = new ArrayList<Partidas>();
      listaPartidas = hpartidas.consultaPartidas("idVenta", "=", String.valueOf(venta.getId()));
      

      
      
      listaPartidasVentas = listaPartidas;
     
      encabezadoPartidas = new Vector<String>();
      encabezadoPartidas.add("Código");
      encabezadoPartidas.add("Descripción");
   //   encabezadoPartidas.add("Precio de Compra");
      encabezadoPartidas.add("Precio de Venta");
   //   encabezadoPartidas.add("Tipo de Beneficio");
   //   encabezadoPartidas.add("Beneficio");
      encabezadoPartidas.add("Unitario con Beneficio");
      encabezadoPartidas.add("Cantidad");
      encabezadoPartidas.add("Subtotal");
      
      vector = new Vector();
      for(Object o: listaPartidas){
             Partidas ipartidas = (Partidas)o;
             Vector<Object> unaFila = new Vector<Object>();
             unaFila.add(ipartidas.getCodigoArticulo());
             unaFila.add(ipartidas.getDescripcionArticulo());
             // unaFila.add(ipartidas.getPrecioCompra());
             unaFila.add(ipartidas.getPrecioVenta());
             // unaFila.add(ipartidas.getTipoBeneficio());
             // unaFila.add(ipartidas.getBeneficio());
             unaFila.add(ipartidas.getConBeneficio());
             unaFila.add(ipartidas.getCantidad());
             unaFila.add(ipartidas.getSubtotal());
             vector.add(unaFila);

         }
           dtm = new DefaultTableModel(vector,encabezadoPartidas) {

              @Override
              public boolean isCellEditable(int row, int column) {
              return false;
                }
              };
           
           
           
          jTable1.setModel(dtm);
          jTable1.getSelectionModel().setSelectionInterval(0, 0);
          listaDevoluciones = new ArrayList<Partidasdevoluciones>();
          hventas = new hVentas();
          hpartidasdevoluciones = new hPartidasDevoluciones();
          this.ventadevuelta = new Devoluciones();
          
            this.ventadevuelta.setArticulos(0);
            this.ventadevuelta.setPartidas(0);
            this.ventadevuelta.setSubtotal(0.0);
            this.ventadevuelta.setTotal(0.0);
            this.ventadevuelta.setIdVenta(venta.getId());
            
            hdevoluciones = new hDevoluciones();
            halmacendevoluciones = new hAlmacendevoluciones();
            almacendevoluciones = new Almacendevoluciones();
            
            harticulos = new hArticulos();
            hkardex = new hKardex();
                   
        hCuentasPorCobrar hcc = new hCuentasPorCobrar();
            
        if(hcc.generarFecha().substring(0,9).equals(jLabel14.getText().substring(0, 9)))
            jButton8.setEnabled(false);
        else
            jButton9.setEnabled(false);
        
        
        if(CGlobalConfig.getNombreSucursal().length == 1 && CGlobalConfig.getNombreSucursal()[0].equals(""))
        jButton3.setEnabled(false);    
        else
        jButton3.setEnabled(CConfiguracion.isMandarSucursal());
        
      if(listaPartidas.size() == 0)
      {    
      jButton4.setEnabled(false);    
      jButton1.setEnabled(false);    
      jButton3.setEnabled(false);    
      jButton8.setEnabled(false);    
      jButton9.setEnabled(false);    
      jButton10.setEnabled(false);    
      jButton2.setEnabled(false);    
      jButton5.setEnabled(false);    
      jButton6.setEnabled(false);    
      jButton7.setEnabled(false);    
      }
            
    }
    
    
      public class TablaSalidaAlmacen extends JPanel   {

    JPanel panelPrincipal, panelEncabezado, panelTabla,fila1,fila2;
    JTable tablaResumen;
    Vector vectorResumen,encabezadoResumen;
    DefaultTableModel dtmResumen;
    JButton boton;
    List<Partidas> listaExtendida;
    JLabel etiquetaCaptura;
    JTextField campoCaptura;

    public TablaSalidaAlmacen(List<Partidas> lista){
      
     setLayout(new GridLayout());
     panelPrincipal = new JPanel();
     panelPrincipal.setBackground(Color.WHITE);
     panelPrincipal.setLayout(new BorderLayout());
     panelEncabezado = new JPanel();
     panelEncabezado.setBackground(Color.WHITE);
     panelEncabezado.setLayout(new GridLayout(2,1));
     fila1 = new JPanel();
     fila2 = new JPanel();
     fila1.setLayout(new FlowLayout());
     fila2.setLayout(new FlowLayout());
     
     etiquetaCaptura = new JLabel("Captura:");
     campoCaptura = new JTextField(20);

     tablaResumen = new JTable();

     encabezadoResumen = new Vector<String>();
     encabezadoResumen.add("Capturado");
     encabezadoResumen.add("Código");
     encabezadoResumen.add("Descripción");
     
     vectorResumen = new Vector();
     
     listaExtendida = new ArrayList<Partidas>();
     for(int i=0; i < lista.size(); i++)
     {
     if(lista.get(i).getCantidad()==1)    
     listaExtendida.add(lista.get(i));
     else if(lista.get(i).getCantidad() > 1)
      {
       for(int a = 0; a < lista.get(i).getCantidad(); a++)
       {
        Partidas partida = new Partidas();
        partida.setCodigoArticulo(lista.get(i).getCodigoArticulo());
        partida.setDescripcionArticulo(lista.get(i).getDescripcionArticulo());
        listaExtendida.add(partida);   
       }
      }        
     }
     
     for(int o=0; o < listaExtendida.size(); o++)
     {
         
     Vector<Object> vecten1r = new Vector();
     vecten1r.add(false);    
     vecten1r.add(listaExtendida.get(o).getCodigoArticulo());    
     vecten1r.add(listaExtendida.get(o).getDescripcionArticulo());
     listaExtendida.get(o).setUbicacion("En espera");
     vectorResumen.add(vecten1r);
     }
     
      dtmResumen = new DefaultTableModel(vectorResumen,encabezadoResumen) {

              @Override
              public boolean isCellEditable(int row, int column) {
              return false;
                }
              
                
               @Override
             public Class<?> getColumnClass(int columnIndex) {
              if (columnIndex == 0) {
              return Boolean.class;
               }
               return super.getColumnClass(columnIndex);
                }
              }; 

      tablaResumen.setModel(dtmResumen);
      boton = new JButton("Validar");
      boton.setBackground(new java.awt.Color(11,70,119));
      boton.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
      boton.setForeground(new java.awt.Color(255, 255, 255));
      boton.setOpaque(true);
      
      
      
      boton.addActionListener(new ActionListener(){

                public void actionPerformed(ActionEvent e) {
                            // TODO add your handling code here:
                 boolean bandera = false;
                 boolean todos = false;
                 for(int u=0; u<listaExtendida.size(); u++)
                 {
                   if(campoCaptura.getText().equals(listaExtendida.get(u).getCodigoArticulo()))
                   {
                   bandera = true;    
                   if(!listaExtendida.get(u).getUbicacion().equals("Lista!"))
                   {
                   dtmResumen.setValueAt(true, u, 0);      
                   listaExtendida.get(u).setUbicacion("Lista!");    
                   u = listaExtendida.size();                   
                   }
                 }
                 }
                    if(!bandera)
                    {
                     JOptionPane.showMessageDialog(null, "El Artículo no está en la lista");   
                     return;
                    }
                    
                   for(int ea=0; ea<listaExtendida.size(); ea++)
                    {
                   if(listaExtendida.get(ea).getUbicacion().equals("Lista!"))
                   {
                    todos = true;    
                   }else
                   {
                    todos  = false;
                    ea = listaExtendida.size();
                   }
                    }
                   
                   if(todos)
                    JOptionPane.showMessageDialog(null, "Venta Completa Validada!");
                }
      });
      
      campoCaptura.addActionListener(new ActionListener(){

                public void actionPerformed(ActionEvent e) {
                    boton.doClick();
                    campoCaptura.setText("");
                    campoCaptura.requestFocus();
                }
      
      });
      
      fila1.add(etiquetaCaptura);
      fila1.add(campoCaptura);
      fila1.add(boton);
      panelEncabezado.add(fila1);
      panelEncabezado.add(fila2);
      panelEncabezado.setBackground(Color.WHITE);
      panelPrincipal.add(new JScrollPane(tablaResumen), BorderLayout.CENTER);
      panelPrincipal.add(panelEncabezado,BorderLayout.NORTH);
      setBackground(Color.WHITE);

      add(panelPrincipal);

    }

}
    
    
}
